<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contribution History - WOSB Guild Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Libre Baskerville', Georgia, serif;
            background: url('wosb-app-background.png') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            color: #3d2b1f;
            padding: 20px;
        }
        
        .header {
            background: rgba(244, 236, 217, 0.95);
            border: 2px solid #8b6914;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 { 
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914; 
            font-size: 24px; 
        }
        
        .navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: rgba(244, 236, 217, 0.9);
            border: 2px solid #8b6914;
            border-radius: 5px;
            color: #3d2b1f;
            text-decoration: none;
            font-family: 'Cinzel', Georgia, serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover { 
            background: #8b6914;
            color: #f5f0e6;
        }
        .nav-btn.active { 
            background: #8b6914; 
            color: #f5f0e6; 
        }
        
        .history-container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(244, 236, 217, 0.95);
            border: 2px solid #8b6914;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .history-item {
            background: rgba(139, 105, 20, 0.1);
            border: 1px solid rgba(139, 105, 20, 0.3);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item-left { flex: 1; }
        
        .history-item-title { 
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914; 
            font-weight: bold; 
            font-size: 16px; 
            margin-bottom: 5px; 
        }
        
        .history-item-details { 
            color: #5c4a3a; 
            font-size: 13px; 
        }
        
        .history-item-right { text-align: right; }
        
        .history-item-points { 
            color: #8b6914; 
            font-size: 20px; 
            font-weight: bold; 
        }
        
        .history-item-date { 
            color: #5c4a3a; 
            font-size: 12px; 
        }
        
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #8b6914;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #5c4a3a;
        }
        
        .empty-state-icon { 
            font-size: 64px; 
            margin-bottom: 20px; 
        }

        .section-header {
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(139, 105, 20, 0.3);
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section:last-child {
            margin-bottom: 0;
        }
        
        .history-item.distribution {
            border-left: 4px solid #8b6914;
        }
        
        .history-item.contribution {
            border-left: 4px solid #2d5a2d;
        }
        
        .distribution-notes {
            font-style: italic;
            color: #5c4a3a;
            font-size: 12px;
            margin-top: 3px;
        }
        
        .section-empty {
            text-align: center;
            padding: 20px;
            color: #5c4a3a;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“œ Contribution History</h1>
    </div>

    <div class="navigation">
    <a href="dashboard.html" class="nav-btn">Dashboard</a>
    <a href="history.html" class="nav-btn active">My History</a>
    <a href="admin.html" class="nav-btn" id="adminNav" style="display: none;">Officer Panel</a>
    <a href="ships.html" class="nav-btn" id="shipsLink" style="display: none;">Ship Database</a>
</div>

    <div class="history-container">
        <div id="loading" class="loading">Loading your history...</div>

        <div id="historyContent" style="display: none;">
            <div class="section">
                <h2 class="section-header">ðŸ“¥ My Contributions</h2>
                <div id="contributionsList"></div>
                <div id="contributionsEmpty" class="section-empty" style="display: none;">
                    No contributions yet. Participate in fort raids and donate materials to earn points!
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-header">ðŸ“¤ Resources Received</h2>
                <div id="distributionsList"></div>
                <div id="distributionsEmpty" class="section-empty" style="display: none;">
                    No resources received yet.
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        let currentUserId = null;

        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                currentUserId = user.uid;
                loadHistory(user.uid);
                loadDistributions(user.uid);
                
                // Check if officer
                const playerDoc = await db.collection('players').doc(user.uid).get();
                if (playerDoc.exists && playerDoc.data().isOfficer) {
                    document.getElementById('adminNav').style.display = 'inline-block';
                    document.getElementById('shipsLink').style.display = 'inline-block';
                }
            }
        });

        function loadHistory(userId) {
            db.collection('contributions')
                .where('playerId', '==', userId)
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('historyContent').style.display = 'block';

                    if (snapshot.empty) {
                        document.getElementById('contributionsEmpty').style.display = 'block';
                        document.getElementById('contributionsList').innerHTML = '';
                    } else {
                        document.getElementById('contributionsEmpty').style.display = 'none';
                        displayContributions(snapshot.docs);
                    }
                }, err => {
                    console.error('Error loading history:', err);
                    alert('Error loading contributions: ' + err.message);
                });
        }

        function loadDistributions(userId) {
            db.collection('distributions')
                .where('playerId', '==', userId)
                .orderBy('timestamp', 'desc')
                .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        document.getElementById('distributionsEmpty').style.display = 'block';
                        document.getElementById('distributionsList').innerHTML = '';
                    } else {
                        document.getElementById('distributionsEmpty').style.display = 'none';
                        displayDistributions(snapshot.docs);
                    }
                }, err => {
                    console.error('Error loading distributions:', err);
                    // Don't alert, just show empty state
                    document.getElementById('distributionsEmpty').style.display = 'block';
                    document.getElementById('distributionsList').innerHTML = '';
                });
        }

        function displayContributions(docs) {
            const list = document.getElementById('contributionsList');
            list.innerHTML = '';

            docs.forEach(doc => {
                const contrib = doc.data();
                const item = document.createElement('div');
                item.className = 'history-item contribution';

                let details = '';
                if (contrib.hoursParticipated) {
                    details = `${contrib.hoursParticipated} hours`;
                } else if (contrib.materialType && contrib.materialQuantity) {
                    details = `${contrib.materialQuantity.toLocaleString()} ${contrib.materialType}`;
                }

                if (contrib.notes) {
                    details += ` â€¢ ${contrib.notes}`;
                }

                let dateStr = 'Just now';
                if (contrib.createdAt) {
                    const date = contrib.createdAt.toDate();
                    dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                }

                item.innerHTML = `
                    <div class="history-item-left">
                        <div class="history-item-title">${contrib.activityType}</div>
                        <div class="history-item-details">${details}</div>
                    </div>
                    <div class="history-item-right">
                        <div class="history-item-points">+${contrib.pointsEarned.toLocaleString()} pts</div>
                        <div class="history-item-date">${dateStr}</div>
                    </div>
                `;

                list.appendChild(item);
            });
        }

        function displayDistributions(docs) {
            const list = document.getElementById('distributionsList');
            list.innerHTML = '';

            docs.forEach(doc => {
                const dist = doc.data();
                const item = document.createElement('div');
                item.className = 'history-item distribution';

                const resourceName = dist.resourceType.charAt(0).toUpperCase() + dist.resourceType.slice(1);

                let dateStr = 'Just now';
                if (dist.timestamp) {
                    const date = dist.timestamp.toDate();
                    dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                }

                item.innerHTML = `
                    <div class="history-item-left">
                        <div class="history-item-title">${dist.quantity.toLocaleString()} ${resourceName}</div>
                        ${dist.notes ? `<div class="distribution-notes">${dist.notes}</div>` : ''}
                        <div class="history-item-details">From: ${dist.performedByName || 'Officer'}</div>
                    </div>
                    <div class="history-item-right">
                        <div class="history-item-date">${dateStr}</div>
                    </div>
                `;

                list.appendChild(item);
            });
        }
    </script>
</body>
</html>