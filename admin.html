<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Officer Panel - WOSB Guild Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Libre Baskerville', Georgia, serif;
            background: url('wosb-app-background.png') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            color: #3d2b1f;
            padding: 20px;
        }
        
        .header {
            background: rgba(244, 236, 217, 0.95);
            border: 2px solid #8b6914;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 { 
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914; 
            font-size: 24px; 
        }
        
        .navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: rgba(244, 236, 217, 0.9);
            border: 2px solid #8b6914;
            border-radius: 5px;
            color: #3d2b1f;
            text-decoration: none;
            font-family: 'Cinzel', Georgia, serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover { 
            background: #8b6914;
            color: #f5f0e6;
        }
        .nav-btn.active { 
            background: #8b6914; 
            color: #f5f0e6; 
        }
        
        .admin-container { max-width: 1400px; margin: 0 auto; }
        
        .card {
            background: rgba(244, 236, 217, 0.95);
            border: 2px solid #8b6914;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .card h3 { 
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914; 
            margin-bottom: 15px; 
            font-size: 18px; 
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        table { width: 100%; border-collapse: collapse; }
        
        th { 
            background: rgba(139, 105, 20, 0.2); 
            color: #8b6914; 
            padding: 12px; 
            text-align: left; 
            font-weight: bold;
            font-family: 'Cinzel', Georgia, serif;
            font-size: 12px;
        }
        
        td { 
            padding: 10px 12px; 
            border-bottom: 1px solid rgba(139, 105, 20, 0.2);
            font-size: 13px;
        }
        
        tr:hover { background: rgba(139, 105, 20, 0.1); }
        
        .btn {
            padding: 8px 15px;
            border: 2px solid #8b6914;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Libre Baskerville', Georgia, serif;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .btn-primary { 
            background: #8b6914; 
            color: #f5f0e6; 
        }
        .btn-primary:hover { 
            background: #6d5310; 
        }
        .btn-success { 
            background: #2d5a2d; 
            color: #f5f0e6;
            border-color: #2d5a2d;
        }
        .btn-success:hover { 
            background: #1e3d1e; 
        }
        
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #8b6914;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .resources-edit {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .resource-edit-item {
            background: rgba(139, 105, 20, 0.1);
            border: 1px solid rgba(139, 105, 20, 0.3);
            padding: 15px;
            border-radius: 5px;
        }
        
        .resource-edit-item label {
            display: block;
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .resource-edit-item input {
            width: 100%;
            padding: 8px;
            background: #f5f0e6;
            border: 2px solid #8b6914;
            border-radius: 5px;
            color: #3d2b1f;
            font-family: 'Libre Baskerville', Georgia, serif;
            font-size: 16px;
        }
        
        .resource-edit-item input:focus {
            outline: none;
            border-color: #c9a227;
        }
        
        .participant-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f5f0e6;
            border: 2px solid #8b6914;
            border-radius: 5px;
            padding: 10px;
        }
        
        .participant-list label {
            display: block;
            padding: 8px;
            cursor: pointer;
            border-radius: 3px;
            color: #3d2b1f;
        }
        
        .participant-list label:hover {
            background: rgba(139, 105, 20, 0.15);
        }
        
        .participant-list input {
            margin-right: 10px;
            accent-color: #8b6914;
        }
        
        .select-all-container {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(139, 105, 20, 0.3);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            background: #f5f0e6;
            border: 2px solid #8b6914;
            border-radius: 5px;
            color: #3d2b1f;
            font-family: 'Libre Baskerville', Georgia, serif;
            font-size: 14px;
        }
        
        .form-group select option {
            background: #f5f0e6;
            color: #3d2b1f;
        }
        
        .tier-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .tier-deckhand { background: rgba(128, 128, 128, 0.2); color: #666; }
        .tier-bosun { background: rgba(205, 127, 50, 0.25); color: #8b5a2b; }
        .tier-quartermaster { background: rgba(150, 150, 150, 0.25); color: #555; }
        .tier-captain { background: rgba(139, 105, 20, 0.25); color: #8b6914; }
        
        .gamertag { font-weight: bold; color: #8b6914; }
        .display-name { font-size: 11px; color: #5c4a3a; }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚öîÔ∏è Officer Panel</h1>
    </div>

    <div class="navigation">
        <a href="dashboard.html" class="nav-btn">Dashboard</a>
        <a href="history.html" class="nav-btn">My History</a>
        <a href="admin.html" class="nav-btn active">Officer Panel</a>
    </div>

    <div id="loading" class="loading">Loading officer panel...</div>

    <div id="adminContent" class="admin-container" style="display: none;">
        
        <div class="card-grid">
            <div class="card">
                <h3>‚öîÔ∏è Log Fort Raid</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Select participants. Each player receives 10 points and +1 fort count.
                </p>
                
                <div class="form-group">
                    <label>Select Participants:</label>
                    <div class="participant-list">
                        <div class="select-all-container">
                            <label>
                                <input type="checkbox" id="selectAllFort" onchange="toggleSelectAll('fort')">
                                <strong>Select All</strong>
                            </label>
                        </div>
                        <div id="fortParticipantsList"></div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="logFortRaid()" style="width: 100%;">
                    Log Fort Raid
                </button>
            </div>

            <div class="card">
                <h3>üì¶ Log Resource Donation</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Record a player's material contribution to the guild.
                </p>
                
                <div class="form-group">
                    <label>Select Player:</label>
                    <select id="donationPlayer">
                        <option value="">-- Select Player --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Resource Type:</label>
                    <select id="donationResource">
                        <option value="">-- Select Resource --</option>
                        <option value="beams">Beams</option>
                        <option value="bulkheads">Bulkheads</option>
                        <option value="plates">Plates</option>
                        <option value="canvas">Canvas</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantity:</label>
                    <input type="number" id="donationQuantity" min="1" placeholder="Enter amount">
                </div>
                
                <button class="btn btn-success" onclick="logResourceDonation()" style="width: 100%;">
                    Log Donation
                </button>
            </div>
        </div>

        <div class="card">
            <h3>üë• All Members</h3>
            <div style="overflow-x: auto;">
                <table id="membersTable">
                    <thead>
                        <tr>
                            <th>Gamertag</th>
                            <th>Total Pts</th>
                            <th>Redeemed</th>
                            <th>Available</th>
                            <th>Tier</th>
                            <th>Goal Ship</th>
                            <th>Forts</th>
                            <th>Last Activity</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>üè¶ Guild Resources</h3>
            <div class="resources-edit" id="resourcesEdit"></div>
            <button class="btn btn-success" onclick="saveAllResources()" style="margin-top: 20px;">
                Save All Resources
            </button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        let allShips = {};
        let allMembers = [];

        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                const playerDoc = await db.collection('players').doc(user.uid).get();
                if (!playerDoc.exists || !playerDoc.data().isOfficer) {
                    alert('Access denied. Officers only.');
                    window.location.href = 'dashboard.html';
                    return;
                }
                loadAdminData();
            }
        });

        async function loadAdminData() {
            try {
                const shipsSnapshot = await db.collection('shipCosts').get();
                shipsSnapshot.docs.forEach(doc => {
                    allShips[doc.id] = doc.data();
                });

                db.collection('players')
                    .orderBy('totalPoints', 'desc')
                    .onSnapshot(snapshot => {
                        allMembers = snapshot.docs;
                        displayMembers(snapshot.docs);
                        updateParticipantLists(snapshot.docs);
                    });

                db.collection('guildResources')
                    .orderBy('materialType')
                    .onSnapshot(snapshot => {
                        displayResources(snapshot.docs);
                    });

                document.getElementById('loading').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';

            } catch (err) {
                console.error('Error loading admin data:', err);
                alert('Error: ' + err.message);
            }
        }

        function displayMembers(docs) {
            const tbody = document.querySelector('#membersTable tbody');
            tbody.innerHTML = '';

            docs.forEach(doc => {
                const member = doc.data();
                const availablePoints = member.totalPoints - member.sharesRedeemed;
                const tier = getTierFromPoints(availablePoints);

                let goalShipName = '-';
                if (member.goalShipId && allShips[member.goalShipId]) {
                    goalShipName = allShips[member.goalShipId].name;
                }

                let lastActivityText = 'Never';
                if (member.lastActivity) {
                    const lastActivity = member.lastActivity.toDate();
                    const daysAgo = Math.floor((Date.now() - lastActivity) / (1000 * 60 * 60 * 24));
                    lastActivityText = daysAgo === 0 ? 'Today' : `${daysAgo}d ago`;
                }

                const squadronPrefix = member.squadron ? `[${member.squadron}] ` : '';
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="gamertag">${member.gamertag ? squadronPrefix + member.gamertag : '-'}</span></td>
                    <td>${formatNumber(member.totalPoints)}</td>
                    <td>${formatNumber(member.sharesRedeemed)}</td>
                    <td>${formatNumber(availablePoints)}</td>
                    <td><span class="tier-badge tier-${tier.name.toLowerCase()}">${tier.emoji} ${tier.name}</span></td>
                    <td>${goalShipName}</td>
                    <td>${member.fortsDestroyed || 0}</td>
                    <td>${lastActivityText}</td>
                `;
            });
        }

        function updateParticipantLists(docs) {
            // Fort participants
            const fortContainer = document.getElementById('fortParticipantsList');
            fortContainer.innerHTML = '';

            // Donation player selector
            const donationSelector = document.getElementById('donationPlayer');
            donationSelector.innerHTML = '<option value="">-- Select Player --</option>';

            docs.forEach(doc => {
                const member = doc.data();
                const displayText = member.gamertag;
                
                // Fort participant checkbox
                const squadronPrefix = member.squadron ? `[${member.squadron}] ` : '';
                const label = document.createElement('label');
                label.innerHTML = `
                    <input type="checkbox" class="fort-participant" value="${doc.id}">
                    ${member.gamertag ? squadronPrefix + displayText : 'No gamertag'} 
                    <span style="color: #5c4a3a; font-size: 11px;">(${member.fortsDestroyed || 0} forts)</span>
                `;
                fortContainer.appendChild(label);

                // Donation player option
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = member.gamertag ? squadronPrefix + displayText : 'No gamertag';
                donationSelector.appendChild(option);
            });
        }

        function toggleSelectAll(type) {
            const selectAll = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`).checked;
            const checkboxes = document.querySelectorAll(`.${type}-participant`);
            checkboxes.forEach(cb => cb.checked = selectAll);
        }

        function displayResources(docs) {
            const container = document.getElementById('resourcesEdit');
            container.innerHTML = '';

            docs.forEach(doc => {
                const resource = doc.data();
                const item = document.createElement('div');
                item.className = 'resource-edit-item';
                item.innerHTML = `
                    <label>${resource.materialType}:</label>
                    <input type="number" 
                           id="resource_${doc.id}" 
                           value="${resource.currentStock}" 
                           min="0">
                `;
                container.appendChild(item);
            });
        }

        async function logFortRaid() {
            const checkboxes = document.querySelectorAll('.fort-participant:checked');
            
            if (checkboxes.length === 0) {
                alert('Select at least one participant');
                return;
            }

            try {
                const batch = db.batch();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                checkboxes.forEach(checkbox => {
                    const playerId = checkbox.value;
                    const playerRef = db.collection('players').doc(playerId);
                    
                    batch.update(playerRef, {
                        totalPoints: firebase.firestore.FieldValue.increment(POINT_VALUES.FORT_RAID),
                        fortsDestroyed: firebase.firestore.FieldValue.increment(1),
                        lastActivity: timestamp
                    });
                    
                    const contribRef = db.collection('contributions').doc();
                    batch.set(contribRef, {
                        playerId: playerId,
                        activityType: 'Fort Raid',
                        pointsEarned: POINT_VALUES.FORT_RAID,
                        materialType: null,
                        materialQuantity: null,
                        notes: 'Fort raid logged by officer',
                        createdAt: timestamp
                    });
                });

                await batch.commit();
                
                alert(`Fort raid logged! ${checkboxes.length} participants awarded ${POINT_VALUES.FORT_RAID} points each.`);
                
                checkboxes.forEach(cb => cb.checked = false);
                document.getElementById('selectAllFort').checked = false;

            } catch (err) {
                console.error('Error logging fort raid:', err);
                alert('Error: ' + err.message);
            }
        }

        async function logResourceDonation() {
            const playerId = document.getElementById('donationPlayer').value;
            const resourceType = document.getElementById('donationResource').value;
            const quantity = parseInt(document.getElementById('donationQuantity').value);

            if (!playerId) {
                alert('Select a player');
                return;
            }
            if (!resourceType) {
                alert('Select a resource type');
                return;
            }
            if (!quantity || quantity < 1) {
                alert('Enter a valid quantity');
                return;
            }

            const pointValue = POINT_VALUES[resourceType.toUpperCase()] || 0;
            if (pointValue === 0) {
                alert('Unknown resource type');
                return;
            }

            const pointsEarned = pointValue * quantity;

            try {
                const batch = db.batch();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                // Update player
                const playerRef = db.collection('players').doc(playerId);
                batch.update(playerRef, {
                    totalPoints: firebase.firestore.FieldValue.increment(pointsEarned),
                    lastActivity: timestamp
                });

                // Add contribution record
                const contribRef = db.collection('contributions').doc();
                batch.set(contribRef, {
                    playerId: playerId,
                    activityType: 'Material Donation',
                    pointsEarned: pointsEarned,
                    materialType: resourceType,
                    materialQuantity: quantity,
                    notes: `Donated ${quantity} ${resourceType}`,
                    createdAt: timestamp
                });

                // Update guild resources
                const resourceQuery = await db.collection('guildResources')
                    .where('materialType', '==', resourceType.charAt(0).toUpperCase() + resourceType.slice(1))
                    .get();
                
                if (!resourceQuery.empty) {
                    const resourceRef = resourceQuery.docs[0].ref;
                    batch.update(resourceRef, {
                        currentStock: firebase.firestore.FieldValue.increment(quantity),
                        lastUpdated: timestamp,
                        updatedBy: auth.currentUser.uid
                    });
                }

                await batch.commit();

                alert(`Donation logged! ${quantity} ${resourceType} = ${pointsEarned} points`);

                // Reset form
                document.getElementById('donationPlayer').value = '';
                document.getElementById('donationResource').value = '';
                document.getElementById('donationQuantity').value = '';

            } catch (err) {
                console.error('Error logging donation:', err);
                alert('Error: ' + err.message);
            }
        }

        async function saveAllResources() {
            try {
                const snapshot = await db.collection('guildResources').get();
                const batch = db.batch();

                snapshot.docs.forEach(doc => {
                    const newStock = parseInt(document.getElementById(`resource_${doc.id}`).value) || 0;
                    batch.update(doc.ref, {
                        currentStock: newStock,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: auth.currentUser.uid
                    });
                });

                await batch.commit();
                alert('Resources updated successfully!');

            } catch (err) {
                console.error('Error updating resources:', err);
                alert('Error: ' + err.message);
            }
        }
    </script>
</body>
</html>