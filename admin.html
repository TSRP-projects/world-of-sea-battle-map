<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Officer Panel - WOSB Guild Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Libre Baskerville', Georgia, serif;
            background: url('wosb-app-background.png') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            color: #3d2b1f;
            padding: 20px;
        }
        
        .header {
            background: rgba(244, 236, 217, 0.95);
            border: 2px solid #8b6914;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 { 
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914; 
            font-size: 24px; 
        }
        
        .navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: rgba(244, 236, 217, 0.9);
            border: 2px solid #8b6914;
            border-radius: 5px;
            color: #3d2b1f;
            text-decoration: none;
            font-family: 'Cinzel', Georgia, serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover { 
            background: #8b6914;
            color: #f5f0e6;
        }
        .nav-btn.active { 
            background: #8b6914; 
            color: #f5f0e6; 
        }
        
        .admin-container { max-width: 1400px; margin: 0 auto; }
        
        .card {
            background: rgba(244, 236, 217, 0.95);
            border: 2px solid #8b6914;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .card h3 { 
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914; 
            margin-bottom: 15px; 
            font-size: 18px; 
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        table { width: 100%; border-collapse: collapse; }
        
        th { 
            background: rgba(139, 105, 20, 0.2); 
            color: #8b6914; 
            padding: 12px; 
            text-align: left; 
            font-weight: bold;
            font-family: 'Cinzel', Georgia, serif;
            font-size: 12px;
        }
        
        td { 
            padding: 10px 12px; 
            border-bottom: 1px solid rgba(139, 105, 20, 0.2);
            font-size: 13px;
        }
        
        tr:hover { background: rgba(139, 105, 20, 0.1); }
        
        .btn {
            padding: 8px 15px;
            border: 2px solid #8b6914;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Libre Baskerville', Georgia, serif;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .btn-primary { 
            background: #8b6914; 
            color: #f5f0e6; 
        }
        .btn-primary:hover { 
            background: #6d5310; 
        }
        .btn-success { 
            background: #2d5a2d; 
            color: #f5f0e6;
            border-color: #2d5a2d;
        }
        .btn-success:hover { 
            background: #1e3d1e; 
        }
        .btn-danger {
            background: #8b3a3a;
            color: #f5f0e6;
            border-color: #8b3a3a;
        }
        .btn-danger:hover {
            background: #6b2a2a;
        }
        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }
        .btn-warning {
            background: #8b6914;
            color: #f5f0e6;
            border-color: #8b6914;
        }
        
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #8b6914;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .resources-edit {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .resource-edit-item {
            background: rgba(139, 105, 20, 0.1);
            border: 1px solid rgba(139, 105, 20, 0.3);
            padding: 15px;
            border-radius: 5px;
        }
        
        .resource-edit-item label {
            display: block;
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .resource-edit-item input {
            width: 100%;
            padding: 8px;
            background: #f5f0e6;
            border: 2px solid #8b6914;
            border-radius: 5px;
            color: #3d2b1f;
            font-family: 'Libre Baskerville', Georgia, serif;
            font-size: 14px;
        }
        
        .resource-edit-item input:focus {
            outline: none;
            border-color: #c9a227;
        }
        
        .participant-list {
            max-height: 250px;
            overflow-y: auto;
            background: #f5f0e6;
            border: 2px solid #8b6914;
            border-radius: 5px;
            padding: 10px;
        }
        
        .participant-list label {
            display: block;
            padding: 8px;
            cursor: pointer;
            border-radius: 3px;
            color: #3d2b1f;
        }
        
        .participant-list label:hover {
            background: rgba(139, 105, 20, 0.15);
        }
        
        .participant-list input {
            margin-right: 10px;
            accent-color: #8b6914;
        }
        
        .select-all-container {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(139, 105, 20, 0.3);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            background: #f5f0e6;
            border: 2px solid #8b6914;
            border-radius: 5px;
            color: #3d2b1f;
            font-family: 'Libre Baskerville', Georgia, serif;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .form-group select option {
            background: #f5f0e6;
            color: #3d2b1f;
        }
        
        .tier-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .tier-deckhand { background: rgba(128, 128, 128, 0.2); color: #666; }
        .tier-bosun { background: rgba(205, 127, 50, 0.25); color: #8b5a2b; }
        .tier-quartermaster { background: rgba(150, 150, 150, 0.25); color: #555; }
        .tier-captain { background: rgba(139, 105, 20, 0.25); color: #8b6914; }
        
        .gamertag { font-weight: bold; color: #8b6914; }
        
        .officer-badge {
            background: #8b6914;
            color: #f5f0e6;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
        
        .ledger-entry {
            padding: 12px;
            border-bottom: 1px solid rgba(139, 105, 20, 0.2);
        }
        
        .ledger-entry:last-child {
            border-bottom: none;
        }
        
        .ledger-entry:hover {
            background: rgba(139, 105, 20, 0.05);
        }
        
        .ledger-action {
            font-weight: bold;
            color: #8b6914;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .ledger-action.action-add { color: #2d5a2d; }
        .ledger-action.action-remove { color: #8b3a3a; }
        .ledger-action.action-officer { color: #8b6914; }
        
        .ledger-details {
            font-size: 13px;
            color: #3d2b1f;
            margin-top: 5px;
        }
        
        .ledger-meta {
            font-size: 11px;
            color: #5c4a3a;
            margin-top: 5px;
        }
        
        .ledger-justification {
            font-style: italic;
            color: #5c4a3a;
            margin-top: 5px;
            padding-left: 10px;
            border-left: 2px solid #8b6914;
        }
        
        .ledger-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: rgba(244, 236, 217, 0.98);
            border: 3px solid #8b6914;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .modal h3 {
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .contributions-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .contribution-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(139, 105, 20, 0.2);
        }
        
        .contribution-item:hover {
            background: rgba(139, 105, 20, 0.1);
        }
        
        .contribution-info {
            flex: 1;
        }
        
        .contribution-type {
            font-weight: bold;
            color: #8b6914;
        }
        
        .contribution-details {
            font-size: 12px;
            color: #5c4a3a;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚öîÔ∏è Officer Panel</h1>
    </div>

    <div class="navigation">
        <a href="dashboard.html" class="nav-btn">Dashboard</a>
        <a href="history.html" class="nav-btn">My History</a>
        <a href="admin.html" class="nav-btn active">Officer Panel</a>
        <a href="ships.html" class="nav-btn">Ship Database</a>
    </div>

    <div id="loading" class="loading">Loading officer panel...</div>

    <div id="adminContent" class="admin-container" style="display: none;">
        
        <div class="card-grid">
            <div class="card">
                <h3>‚öîÔ∏è Log Fort Raid</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Select participants. Each player receives 10 points and +1 fort count.
                </p>
                
                <div class="form-group">
                    <label>Select Participants:</label>
                    <div class="participant-list">
                        <div class="select-all-container">
                            <label>
                                <input type="checkbox" id="selectAllFort" onchange="toggleSelectAll('fort')">
                                <strong>Select All</strong>
                            </label>
                        </div>
                        <div id="fortParticipantsList"></div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="logFortRaid()" style="width: 100%;">
                    Log Fort Raid
                </button>
            </div>

            <div class="card">
                <h3>üì¶ Log Resource Donation</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Record a player's material contribution to the guild.
                </p>
                
                <div class="form-group">
                    <label>Select Player:</label>
                    <select id="donationPlayer">
                        <option value="">-- Select Player --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Resource Type:</label>
                    <select id="donationResource">
                        <option value="">-- Select Resource --</option>
                        <optgroup label="Crafted Resources">
                            <option value="beams">Beams (1 pt each)</option>
                            <option value="bulkheads">Bulkheads (2 pts each)</option>
                            <option value="plates">Plates (1 pt each)</option>
                            <option value="canvas">Canvas (1 pt per 2)</option>
                        </optgroup>
                        <optgroup label="Raw Materials">
                            <option value="iron">Iron (1 pt per 100)</option>
                            <option value="wood">Wood (1 pt per 1000)</option>
                            <option value="resin">Resin (1 pt per 200)</option>
                            <option value="fabric">Fabric (1 pt per 2000)</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantity:</label>
                    <input type="number" id="donationQuantity" min="1" placeholder="Enter amount">
                </div>
                
                <button class="btn btn-success" onclick="logResourceDonation()" style="width: 100%;">
                    Log Donation
                </button>
            </div>

            <div class="card">
                <h3>üëë Manage Officers</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Promote or demote players to officer status.
                </p>
                
                <div class="form-group">
                    <label>Select Player:</label>
                    <select id="officerPlayer">
                        <option value="">-- Select Player --</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="promoteToOfficer()" style="flex: 1;">
                        Promote to Officer
                    </button>
                    <button class="btn btn-danger" onclick="demoteOfficer()" style="flex: 1;">
                        Remove Officer
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>üë• All Members</h3>
            <div style="overflow-x: auto;">
                <table id="membersTable">
                    <thead>
                        <tr>
                            <th>Gamertag</th>
                            <th>Total Pts</th>
                            <th>Redeemed</th>
                            <th>Available</th>
                            <th>Tier</th>
                            <th>Goal Ship</th>
                            <th>Forts</th>
                            <th>Last Activity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="card-grid">
            <div class="card">
                <h3>üè¶ Guild Resources</h3>
                <div class="resources-edit" id="resourcesEdit"></div>
                <button class="btn btn-success" onclick="saveAllResources()" style="margin-top: 20px; width: 100%;">
                    Save All Resources
                </button>
            </div>

            <div class="card">
                <h3>üìú Admiral's Ledger</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Log of all officer actions.
                </p>
                <div class="ledger-container" id="ledgerContainer">
                    <div style="text-align: center; color: #5c4a3a;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Remove Contribution Modal -->
    <div class="modal-overlay" id="removeContributionModal">
        <div class="modal">
            <h3>üóëÔ∏è Remove Contribution</h3>
            <div id="contributionsList" class="contributions-list"></div>
            <div class="form-group" style="margin-top: 15px;">
                <label>Justification (required):</label>
                <textarea id="removeJustification" placeholder="Explain why this entry is being removed..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="closeRemoveModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmRemoveContribution()">Remove Selected</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        let allShips = {};
        let allMembers = [];
        let currentOfficer = null;
        let selectedPlayerId = null;
        let selectedContributionId = null;

        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                const playerDoc = await db.collection('players').doc(user.uid).get();
                if (!playerDoc.exists || !playerDoc.data().isOfficer) {
                    alert('Access denied. Officers only.');
                    window.location.href = 'dashboard.html';
                    return;
                }
                currentOfficer = { id: user.uid, ...playerDoc.data() };
                loadAdminData();
            }
        });

        async function loadAdminData() {
            try {
                const shipsSnapshot = await db.collection('shipCosts').get();
                shipsSnapshot.docs.forEach(doc => {
                    allShips[doc.id] = doc.data();
                });

                db.collection('players')
                    .orderBy('totalPoints', 'desc')
                    .onSnapshot(snapshot => {
                        allMembers = snapshot.docs;
                        displayMembers(snapshot.docs);
                        updateParticipantLists(snapshot.docs);
                    });

                db.collection('guildResources')
                    .orderBy('materialType')
                    .onSnapshot(snapshot => {
                        displayResources(snapshot.docs);
                    });

                db.collection('admiralLedger')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .onSnapshot(snapshot => {
                        displayLedger(snapshot.docs);
                    });

                document.getElementById('loading').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';

            } catch (err) {
                console.error('Error loading admin data:', err);
                alert('Error: ' + err.message);
            }
        }

        function displayMembers(docs) {
            const tbody = document.querySelector('#membersTable tbody');
            tbody.innerHTML = '';

            docs.forEach(doc => {
                const member = doc.data();
                const availablePoints = member.totalPoints - member.sharesRedeemed;
                const tier = getTierFromPoints(availablePoints);

                let goalShipName = '-';
                if (member.goalShipId && allShips[member.goalShipId]) {
                    goalShipName = allShips[member.goalShipId].name;
                }

                let lastActivityText = 'Never';
                if (member.lastActivity) {
                    const lastActivity = member.lastActivity.toDate();
                    const daysAgo = Math.floor((Date.now() - lastActivity) / (1000 * 60 * 60 * 24));
                    lastActivityText = daysAgo === 0 ? 'Today' : `${daysAgo}d ago`;
                }

                const squadronPrefix = member.squadron ? `[${member.squadron}] ` : '';
                const officerBadge = member.isOfficer ? '<span class="officer-badge">OFFICER</span>' : '';

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="gamertag">${member.gamertag ? squadronPrefix + member.gamertag : '-'}</span>${officerBadge}</td>
                    <td>${formatNumber(member.totalPoints)}</td>
                    <td>${formatNumber(member.sharesRedeemed)}</td>
                    <td>${formatNumber(availablePoints)}</td>
                    <td><span class="tier-badge tier-${tier.name.toLowerCase()}">${tier.emoji} ${tier.name}</span></td>
                    <td>${goalShipName}</td>
                    <td>${member.fortsDestroyed || 0}</td>
                    <td>${lastActivityText}</td>
                    <td>
                        <button class="btn btn-small btn-warning" onclick="openRemoveModal('${doc.id}')">
                            Manage
                        </button>
                    </td>
                `;
            });
        }

        function updateParticipantLists(docs) {
            const fortContainer = document.getElementById('fortParticipantsList');
            fortContainer.innerHTML = '';

            const donationSelector = document.getElementById('donationPlayer');
            donationSelector.innerHTML = '<option value="">-- Select Player --</option>';

            const officerSelector = document.getElementById('officerPlayer');
            officerSelector.innerHTML = '<option value="">-- Select Player --</option>';

            docs.forEach(doc => {
                const member = doc.data();
                const squadronPrefix = member.squadron ? `[${member.squadron}] ` : '';
                const displayText = member.gamertag ? squadronPrefix + member.gamertag : 'No gamertag';
                
                // Fort participant checkbox
                const label = document.createElement('label');
                label.innerHTML = `
                    <input type="checkbox" class="fort-participant" value="${doc.id}">
                    ${displayText}
                    <span style="color: #5c4a3a; font-size: 11px;">(${member.fortsDestroyed || 0} forts)</span>
                `;
                fortContainer.appendChild(label);

                // Donation player option
                const donationOption = document.createElement('option');
                donationOption.value = doc.id;
                donationOption.textContent = displayText;
                donationSelector.appendChild(donationOption);

                // Officer player option
                const officerOption = document.createElement('option');
                officerOption.value = doc.id;
                officerOption.textContent = displayText + (member.isOfficer ? ' (Officer)' : '');
                officerSelector.appendChild(officerOption);
            });
        }

        function toggleSelectAll(type) {
            const selectAll = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`).checked;
            const checkboxes = document.querySelectorAll(`.${type}-participant`);
            checkboxes.forEach(cb => cb.checked = selectAll);
        }

        function displayResources(docs) {
            const container = document.getElementById('resourcesEdit');
            container.innerHTML = '';

            docs.forEach(doc => {
                const resource = doc.data();
                const item = document.createElement('div');
                item.className = 'resource-edit-item';
                item.innerHTML = `
                    <label>${resource.materialType}:</label>
                    <input type="number" 
                           id="resource_${doc.id}" 
                           value="${resource.currentStock}" 
                           min="0">
                `;
                container.appendChild(item);
            });
        }

        function displayLedger(docs) {
            const container = document.getElementById('ledgerContainer');
            
            if (docs.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #5c4a3a;">No entries yet</div>';
                return;
            }

            container.innerHTML = '';

            docs.forEach(doc => {
                const entry = doc.data();
                let actionClass = 'action-add';
                if (entry.action.includes('Remove') || entry.action.includes('Demote')) {
                    actionClass = 'action-remove';
                } else if (entry.action.includes('Officer') || entry.action.includes('Promote')) {
                    actionClass = 'action-officer';
                }

                const timestamp = entry.timestamp ? entry.timestamp.toDate().toLocaleString() : 'Unknown';

                const entryDiv = document.createElement('div');
                entryDiv.className = 'ledger-entry';
                entryDiv.innerHTML = `
                    <div class="ledger-action ${actionClass}">${entry.action}</div>
                    <div class="ledger-details">${entry.details || ''}</div>
                    ${entry.justification ? `<div class="ledger-justification">"${entry.justification}"</div>` : ''}
                    <div class="ledger-meta">By ${entry.performedByName || 'Unknown'} ‚Ä¢ ${timestamp}</div>
                `;
                container.appendChild(entryDiv);
            });
        }

        async function logToLedger(action, details, justification = null) {
            try {
                await db.collection('admiralLedger').add({
                    action: action,
                    details: details,
                    justification: justification,
                    performedBy: currentOfficer.id,
                    performedByName: currentOfficer.gamertag || currentOfficer.displayName || 'Unknown',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (err) {
                console.error('Error logging to ledger:', err);
            }
        }

        async function logFortRaid() {
            const checkboxes = document.querySelectorAll('.fort-participant:checked');
            
            if (checkboxes.length === 0) {
                alert('Select at least one participant');
                return;
            }

            try {
                const batch = db.batch();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                const participantNames = [];

                for (const checkbox of checkboxes) {
                    const playerId = checkbox.value;
                    const playerDoc = allMembers.find(m => m.id === playerId);
                    const playerData = playerDoc ? playerDoc.data() : {};
                    const playerName = playerData.gamertag || 'Unknown';
                    participantNames.push(playerName);

                    const playerRef = db.collection('players').doc(playerId);
                    
                    batch.update(playerRef, {
                        totalPoints: firebase.firestore.FieldValue.increment(POINT_VALUES.FORT_RAID),
                        fortsDestroyed: firebase.firestore.FieldValue.increment(1),
                        lastActivity: timestamp
                    });
                    
                    const contribRef = db.collection('contributions').doc();
                    batch.set(contribRef, {
                        playerId: playerId,
                        playerName: playerName,
                        activityType: 'Fort Raid',
                        pointsEarned: POINT_VALUES.FORT_RAID,
                        materialType: null,
                        materialQuantity: null,
                        notes: 'Fort raid logged by officer',
                        loggedBy: currentOfficer.id,
                        loggedByName: currentOfficer.gamertag || currentOfficer.displayName,
                        createdAt: timestamp
                    });
                }

                await batch.commit();
                
                await logToLedger(
                    'Fort Raid Logged',
                    `${checkboxes.length} participants: ${participantNames.join(', ')} (+${POINT_VALUES.FORT_RAID} pts each)`
                );
                
                alert(`Fort raid logged! ${checkboxes.length} participants awarded ${POINT_VALUES.FORT_RAID} points each.`);
                
                checkboxes.forEach(cb => cb.checked = false);
                document.getElementById('selectAllFort').checked = false;

            } catch (err) {
                console.error('Error logging fort raid:', err);
                alert('Error: ' + err.message);
            }
        }

       async function logResourceDonation() {
            const playerId = document.getElementById('donationPlayer').value;
            const resourceType = document.getElementById('donationResource').value;
            const quantity = parseInt(document.getElementById('donationQuantity').value);

            if (!playerId) {
                alert('Select a player');
                return;
            }
            if (!resourceType) {
                alert('Select a resource type');
                return;
            }
            if (!quantity || quantity < 1) {
                alert('Enter a valid quantity');
                return;
            }

            const pointValue = POINT_VALUES[resourceType.toUpperCase()] || 0;
            if (pointValue === 0) {
                alert('Unknown resource type');
                return;
            }

            const pointsEarned = Math.floor(pointValue * quantity);
            
            if (pointsEarned < 1) {
                alert(`Quantity too low. Minimum for ${resourceType}:\n` +
                      `- Iron: 100\n- Wood: 1000\n- Resin: 200\n- Fabric: 2000\n- Canvas: 2`);
                return;
            }

            const playerDoc = allMembers.find(m => m.id === playerId);
            const playerData = playerDoc ? playerDoc.data() : {};
            const playerName = playerData.gamertag || 'Unknown';

            // Determine if this is a crafted resource that goes to guild storage
            const guildStorageResources = ['beams', 'bulkheads', 'plates', 'canvas'];
            const isGuildStorageResource = guildStorageResources.includes(resourceType);

            try {
                const batch = db.batch();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                const playerRef = db.collection('players').doc(playerId);
                batch.update(playerRef, {
                    totalPoints: firebase.firestore.FieldValue.increment(pointsEarned),
                    lastActivity: timestamp
                });

                const contribRef = db.collection('contributions').doc();
                batch.set(contribRef, {
                    playerId: playerId,
                    playerName: playerName,
                    activityType: 'Material Donation',
                    pointsEarned: pointsEarned,
                    materialType: resourceType,
                    materialQuantity: quantity,
                    notes: `Donated ${formatNumber(quantity)} ${resourceType}`,
                    loggedBy: currentOfficer.id,
                    loggedByName: currentOfficer.gamertag || currentOfficer.displayName,
                    createdAt: timestamp
                });

                // Only update guild storage for crafted resources
                if (isGuildStorageResource) {
                    const resourceName = resourceType.charAt(0).toUpperCase() + resourceType.slice(1);
                    const resourceQuery = await db.collection('guildResources')
                        .where('materialType', '==', resourceName)
                        .get();
                    
                    if (!resourceQuery.empty) {
                        const resourceRef = resourceQuery.docs[0].ref;
                        batch.update(resourceRef, {
                            currentStock: firebase.firestore.FieldValue.increment(quantity),
                            lastUpdated: timestamp,
                            updatedBy: auth.currentUser.uid
                        });
                    }
                }

                await batch.commit();

                await logToLedger(
                    'Resource Donation Logged',
                    `${playerName} donated ${formatNumber(quantity)} ${resourceType} (+${pointsEarned} pts)${isGuildStorageResource ? ' [Added to guild storage]' : ''}`
                );

                alert(`Donation logged!\n${formatNumber(quantity)} ${resourceType} = ${pointsEarned} points${isGuildStorageResource ? '\nAdded to guild storage' : ''}`);

                document.getElementById('donationPlayer').value = '';
                document.getElementById('donationResource').value = '';
                document.getElementById('donationQuantity').value = '';

            } catch (err) {
                console.error('Error logging donation:', err);
                alert('Error: ' + err.message);
            }
        }
        async function promoteToOfficer() {
            const playerId = document.getElementById('officerPlayer').value;
            if (!playerId) {
                alert('Select a player');
                return;
            }

            const playerDoc = allMembers.find(m => m.id === playerId);
            const playerData = playerDoc ? playerDoc.data() : {};
            
            if (playerData.isOfficer) {
                alert('This player is already an officer');
                return;
            }

            const playerName = playerData.gamertag || 'Unknown';

            if (!confirm(`Promote ${playerName} to Officer?`)) return;

            try {
                await db.collection('players').doc(playerId).update({
                    isOfficer: true
                });

                await logToLedger(
                    'Officer Promoted',
                    `${playerName} was promoted to Officer`
                );

                alert(`${playerName} is now an Officer!`);
                document.getElementById('officerPlayer').value = '';

            } catch (err) {
                console.error('Error promoting officer:', err);
                alert('Error: ' + err.message);
            }
        }

        async function demoteOfficer() {
            const playerId = document.getElementById('officerPlayer').value;
            if (!playerId) {
                alert('Select a player');
                return;
            }

            const playerDoc = allMembers.find(m => m.id === playerId);
            const playerData = playerDoc ? playerDoc.data() : {};
            
            if (!playerData.isOfficer) {
                alert('This player is not an officer');
                return;
            }

            if (playerId === currentOfficer.id) {
                alert('You cannot demote yourself');
                return;
            }

            const playerName = playerData.gamertag || 'Unknown';

            if (!confirm(`Remove Officer status from ${playerName}?`)) return;

            try {
                await db.collection('players').doc(playerId).update({
                    isOfficer: false
                });

                await logToLedger(
                    'Officer Demoted',
                    `${playerName} was removed as Officer`
                );

                alert(`${playerName} is no longer an Officer`);
                document.getElementById('officerPlayer').value = '';

            } catch (err) {
                console.error('Error demoting officer:', err);
                alert('Error: ' + err.message);
            }
        }

        async function openRemoveModal(playerId) {
            selectedPlayerId = playerId;
            const playerDoc = allMembers.find(m => m.id === playerId);
            const playerData = playerDoc ? playerDoc.data() : {};
            const playerName = playerData.gamertag || 'Unknown';

            const contributionsSnapshot = await db.collection('contributions')
                .where('playerId', '==', playerId)
                .orderBy('createdAt', 'desc')
                .limit(20)
                .get();

            const container = document.getElementById('contributionsList');
            
            if (contributionsSnapshot.empty) {
                container.innerHTML = `<p style="text-align: center; color: #5c4a3a;">No contributions found for ${playerName}</p>`;
            } else {
                container.innerHTML = `<p style="margin-bottom: 10px; color: #8b6914; font-weight: bold;">Contributions for ${playerName}:</p>`;
                
                contributionsSnapshot.docs.forEach(doc => {
                    const contrib = doc.data();
                    const date = contrib.createdAt ? contrib.createdAt.toDate().toLocaleDateString() : 'Unknown';
                    
                    const item = document.createElement('div');
                    item.className = 'contribution-item';
                    item.innerHTML = `
                        <input type="radio" name="selectedContribution" value="${doc.id}" style="margin-right: 10px; accent-color: #8b6914;">
                        <div class="contribution-info">
                            <div class="contribution-type">${contrib.activityType}</div>
                            <div class="contribution-details">
                                ${contrib.materialType ? `${contrib.materialQuantity} ${contrib.materialType} ‚Ä¢ ` : ''}
                                +${contrib.pointsEarned} pts ‚Ä¢ ${date}
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }

            document.getElementById('removeJustification').value = '';
            document.getElementById('removeContributionModal').classList.add('active');
        }

        function closeRemoveModal() {
            document.getElementById('removeContributionModal').classList.remove('active');
            selectedPlayerId = null;
        }

        async function confirmRemoveContribution() {
            const selectedRadio = document.querySelector('input[name="selectedContribution"]:checked');
            if (!selectedRadio) {
                alert('Select a contribution to remove');
                return;
            }

            const justification = document.getElementById('removeJustification').value.trim();
            if (!justification) {
                alert('Justification is required');
                return;
            }

            const contributionId = selectedRadio.value;

            try {
                const contribDoc = await db.collection('contributions').doc(contributionId).get();
                if (!contribDoc.exists) {
                    alert('Contribution not found');
                    return;
                }

                const contrib = contribDoc.data();
                const playerDoc = allMembers.find(m => m.id === contrib.playerId);
                const playerData = playerDoc ? playerDoc.data() : {};
                const playerName = playerData.gamertag || contrib.playerName || 'Unknown';

                if (!confirm(`Remove this ${contrib.activityType} entry?\n\nThis will deduct ${contrib.pointsEarned} points from ${playerName}.`)) {
                    return;
                }

                const batch = db.batch();

                // Remove points from player
                const playerRef = db.collection('players').doc(contrib.playerId);
                const updateData = {
                    totalPoints: firebase.firestore.FieldValue.increment(-contrib.pointsEarned)
                };

                if (contrib.activityType === 'Fort Raid') {
                    updateData.fortsDestroyed = firebase.firestore.FieldValue.increment(-1);
                }

                batch.update(playerRef, updateData);

                // If material donation, remove from guild resources (only for crafted resources)
                if (contrib.materialType && contrib.materialQuantity) {
                    const guildStorageResources = ['beams', 'bulkheads', 'plates', 'canvas'];
                    if (guildStorageResources.includes(contrib.materialType.toLowerCase())) {
                        const resourceName = contrib.materialType.charAt(0).toUpperCase() + contrib.materialType.slice(1);
                        const resourceQuery = await db.collection('guildResources')
                            .where('materialType', '==', resourceName)
                            .get();
                        
                        if (!resourceQuery.empty) {
                            batch.update(resourceQuery.docs[0].ref, {
                                currentStock: firebase.firestore.FieldValue.increment(-contrib.materialQuantity)
                            });
                        }
                    }
                }

                // Delete the contribution
                batch.delete(db.collection('contributions').doc(contributionId));

                await batch.commit();

                await logToLedger(
                    'Contribution Removed',
                    `Removed ${contrib.activityType} from ${playerName} (-${contrib.pointsEarned} pts)${contrib.materialType ? ` ‚Ä¢ ${contrib.materialQuantity} ${contrib.materialType} returned` : ''}`,
                    justification
                );

                alert('Contribution removed successfully');
                closeRemoveModal();

            } catch (err) {
                console.error('Error removing contribution:', err);
                alert('Error: ' + err.message);
            }
        }

        async function saveAllResources() {
            try {
                const snapshot = await db.collection('guildResources').get();
                const batch = db.batch();

                snapshot.docs.forEach(doc => {
                    const newStock = parseInt(document.getElementById(`resource_${doc.id}`).value) || 0;
                    batch.update(doc.ref, {
                        currentStock: newStock,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: auth.currentUser.uid
                    });
                });

                await batch.commit();

                await logToLedger(
                    'Guild Resources Updated',
                    'Manual update to guild resource stockpiles'
                );

                alert('Resources updated successfully!');

            } catch (err) {
                console.error('Error updating resources:', err);
                alert('Error: ' + err.message);
            }
        }
    </script>
</body>
</html>