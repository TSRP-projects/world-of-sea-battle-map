<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Officer Panel - WOSB Guild Tracker</title>
    <link rel="icon" type="image/png" href="Blackwolf Holdings Medallion.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Libre Baskerville', Georgia, serif;
            background: url('wosb-app-background.png') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            color: #3d2b1f;
            padding: 20px;
        }
        
        .header {
            background: rgba(244, 236, 217, 0.95);
            border: 2px solid #8b6914;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 { 
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914; 
            font-size: 24px; 
        }
        
        .navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: rgba(244, 236, 217, 0.9);
            border: 2px solid #8b6914;
            border-radius: 5px;
            color: #3d2b1f;
            text-decoration: none;
            font-family: 'Cinzel', Georgia, serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover { 
            background: #8b6914;
            color: #f5f0e6;
        }
        .nav-btn.active { 
            background: #8b6914; 
            color: #f5f0e6; 
        }
        
        .admin-container { max-width: 1400px; margin: 0 auto; }
        
        .card {
            background: rgba(244, 236, 217, 0.95);
            border: 2px solid #8b6914;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .card h3 { 
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914; 
            margin-bottom: 15px; 
            font-size: 18px; 
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        table { width: 100%; border-collapse: collapse; }
        
        th { 
            background: rgba(139, 105, 20, 0.2); 
            color: #8b6914; 
            padding: 12px; 
            text-align: left; 
            font-weight: bold;
            font-family: 'Cinzel', Georgia, serif;
            font-size: 12px;
        }
        
        td { 
            padding: 10px 12px; 
            border-bottom: 1px solid rgba(139, 105, 20, 0.2);
            font-size: 13px;
        }
        
        tr:hover { background: rgba(139, 105, 20, 0.1); }
        
        .btn {
            padding: 8px 15px;
            border: 2px solid #8b6914;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Libre Baskerville', Georgia, serif;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .btn-primary { 
            background: #8b6914; 
            color: #f5f0e6; 
        }
        .btn-primary:hover { 
            background: #6d5310; 
        }
        .btn-success { 
            background: #2d5a2d; 
            color: #f5f0e6;
            border-color: #2d5a2d;
        }
        .btn-success:hover { 
            background: #1e3d1e; 
        }
        .btn-danger {
            background: #8b3a3a;
            color: #f5f0e6;
            border-color: #8b3a3a;
        }
        .btn-danger:hover {
            background: #6b2a2a;
        }
        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }
        .btn-warning {
            background: #8b6914;
            color: #f5f0e6;
            border-color: #8b6914;
        }
        
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #8b6914;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .participant-list {
            max-height: 250px;
            overflow-y: auto;
            background: #f5f0e6;
            border: 2px solid #8b6914;
            border-radius: 5px;
            padding: 10px;
        }
        
        .participant-list label {
            display: block;
            padding: 8px;
            cursor: pointer;
            border-radius: 3px;
            color: #3d2b1f;
        }
        
        .participant-list label:hover {
            background: rgba(139, 105, 20, 0.15);
        }
        
        .participant-list input {
            margin-right: 10px;
            accent-color: #8b6914;
        }
        
        .select-all-container {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(139, 105, 20, 0.3);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            background: #f5f0e6;
            border: 2px solid #8b6914;
            border-radius: 5px;
            color: #3d2b1f;
            font-family: 'Libre Baskerville', Georgia, serif;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .form-group select option {
            background: #f5f0e6;
            color: #3d2b1f;
        }
        
        .gamertag { font-weight: bold; color: #8b6914; }
        
        .officer-badge {
            background: #8b6914;
            color: #f5f0e6;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
        
        .ledger-entry {
            padding: 12px;
            border-bottom: 1px solid rgba(139, 105, 20, 0.2);
        }
        
        .ledger-entry:last-child {
            border-bottom: none;
        }
        
        .ledger-entry:hover {
            background: rgba(139, 105, 20, 0.05);
        }
        
        .ledger-action {
            font-weight: bold;
            color: #8b6914;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .ledger-action.action-add { color: #2d5a2d; }
        .ledger-action.action-remove { color: #8b3a3a; }
        .ledger-action.action-officer { color: #8b6914; }
        
        .ledger-details {
            font-size: 13px;
            color: #3d2b1f;
            margin-top: 5px;
        }
        
        .ledger-meta {
            font-size: 11px;
            color: #5c4a3a;
            margin-top: 5px;
        }
        
        .ledger-justification {
            font-style: italic;
            color: #5c4a3a;
            margin-top: 5px;
            padding-left: 10px;
            border-left: 2px solid #8b6914;
        }
        
        .ledger-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: rgba(244, 236, 217, 0.98);
            border: 3px solid #8b6914;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .modal h3 {
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .contributions-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .contribution-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(139, 105, 20, 0.2);
        }
        
        .contribution-item:hover {
            background: rgba(139, 105, 20, 0.1);
        }
        
        .contribution-info {
            flex: 1;
        }
        
        .contribution-type {
            font-weight: bold;
            color: #8b6914;
        }
        
        .contribution-details {
            font-size: 12px;
            color: #5c4a3a;
        }

        .details-row {
            background: rgba(139, 105, 20, 0.08);
        }
        
        .details-row td {
            padding: 0;
        }
        
        .details-content {
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .details-section h4 {
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914;
            font-size: 14px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(139, 105, 20, 0.3);
        }
        
        .details-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .details-item {
            padding: 8px;
            border-bottom: 1px solid rgba(139, 105, 20, 0.15);
            font-size: 12px;
        }
        
        .details-item:last-child {
            border-bottom: none;
        }
        
        .details-item-type {
            font-weight: bold;
            color: #2d5a2d;
        }
        
        .details-item-type.distribution {
            color: #8b6914;
        }
        
        .details-item-meta {
            color: #5c4a3a;
            font-size: 11px;
            margin-top: 3px;
        }
        
        .no-records {
            color: #5c4a3a;
            font-style: italic;
            padding: 10px;
        }

        .crafting-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            background: #f5f0e6;
            border: 2px solid #8b6914;
            border-radius: 5px;
            padding: 15px;
        }

        .crafting-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .crafting-label {
            min-width: 50px;
            font-size: 13px;
            color: #3d2b1f;
        }

        .crafting-input-row input {
            flex: 1;
            padding: 8px;
            background: #fff;
            border: 1px solid #8b6914;
            border-radius: 3px;
            font-family: 'Libre Baskerville', Georgia, serif;
            font-size: 14px;
            color: #3d2b1f;
        }

        .admiral-badge {
            background: #2d5a2d;
            color: #f5f0e6;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }

        .guild-alliance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(139, 105, 20, 0.1);
            border: 1px solid rgba(139, 105, 20, 0.2);
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .guild-alliance-item:last-child {
            margin-bottom: 0;
        }

        .guild-alliance-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .guild-alliance-logo {
            width: 40px;
            height: 40px;
            object-fit: contain;
            border-radius: 50%;
            border: 2px solid #8b6914;
        }

        .guild-alliance-name {
            font-weight: bold;
            color: #8b6914;
        }

        .guild-alliance-meta {
            font-size: 12px;
            color: #5c4a3a;
        }

        .partner-badge {
            background: #2d5a2d;
            color: #f5f0e6;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 8px;
        }

        .non-partner-badge {
            background: #5c4a3a;
            color: #f5f0e6;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 8px;
        }

        .resource-group {
            background: rgba(139, 105, 20, 0.1);
            border: 1px solid rgba(139, 105, 20, 0.3);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .resource-group:last-child {
            margin-bottom: 0;
        }

        .resource-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(139, 105, 20, 0.3);
        }

        .resource-group-name {
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914;
            font-size: 16px;
            font-weight: bold;
        }

        .resource-group-total {
            font-size: 18px;
            font-weight: bold;
            color: #2d5a2d;
        }

        .resource-location {
            margin-left: 10px;
            padding: 8px 12px;
            background: rgba(139, 105, 20, 0.05);
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .resource-location:last-child {
            margin-bottom: 0;
        }

        .resource-location-header {
            font-weight: bold;
            color: #5c4a3a;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .resource-officer-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-left: 10px;
        }

        .resource-officer-item {
            background: rgba(139, 105, 20, 0.15);
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 12px;
            color: #3d2b1f;
        }

        .resource-officer-name {
            color: #8b6914;
            font-weight: bold;
        }

        .resource-no-data {
            color: #5c4a3a;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .rate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(139, 105, 20, 0.1);
            border: 1px solid rgba(139, 105, 20, 0.2);
            border-radius: 5px;
            margin-bottom: 8px;
        }

        .rate-item:last-child {
            margin-bottom: 0;
        }

        .rate-resource {
            font-weight: bold;
            color: #3d2b1f;
        }

        .rate-value {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rate-input {
            width: 70px;
            padding: 5px;
            text-align: center;
            border: 1px solid #8b6914;
            border-radius: 3px;
            font-family: 'Libre Baskerville', Georgia, serif;
        }

        .rate-multiplier {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .rate-normal { background: rgba(139, 105, 20, 0.2); color: #8b6914; }
        .rate-needed { background: rgba(45, 90, 45, 0.2); color: #2d5a2d; }
        .rate-critical { background: rgba(139, 58, 58, 0.2); color: #8b3a3a; }
        .rate-surplus { background: rgba(90, 90, 90, 0.2); color: #666; }

    </style>
</head>
<body>
    <div class="header">
        <h1>‚öîÔ∏è Officer Panel</h1>
    </div>

    <div class="navigation">
        <a href="dashboard.html" class="nav-btn">Dashboard</a>
        <a href="history.html" class="nav-btn">My History</a>
        <a href="admin.html" class="nav-btn active">Officer Panel</a>
        <a href="guild-panel.html" class="nav-btn" id="guildNav" style="display: none;">Guild Panel</a>
        <a href="ships.html" class="nav-btn">Ship Database</a>
    </div>

    <div id="loading" class="loading">Loading officer panel...</div>

    <div id="adminContent" class="admin-container" style="display: none;">
        
        <div class="card-grid">
            <div class="card">
                <h3>‚öîÔ∏è Log Fort Raid</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Select participants. Each player receives 10 Holding Coins and +1 fort count.
                </p>
                
                <div class="form-group">
                    <label>Select Participants:</label>
                    <div class="participant-list">
                        <div class="select-all-container">
                            <label>
                                <input type="checkbox" id="selectAllFort" onchange="toggleSelectAll('fort')">
                                <strong>Select All</strong>
                            </label>
                        </div>
                        <div id="fortParticipantsList"></div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="logFortRaid()" style="width: 100%;">
                    Log Fort Raid
                </button>
            </div>

            <div class="card">
                <h3>üì¶ Log Resource Donation</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Record a player's material contribution. HC earned based on current exchange rates.
                </p>
                
                <div class="form-group">
                    <label>Select Player:</label>
                    <select id="donationPlayer">
                        <option value="">-- Select Player --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Resource Type:</label>
                    <select id="donationResource" onchange="updateDonationPreview()">
                        <option value="">-- Select Resource --</option>
                        <optgroup label="Crafted Resources">
                            <option value="beams">Beams</option>
                            <option value="bulkheads">Bulkheads</option>
                            <option value="plates">Plates</option>
                            <option value="canvas">Canvas</option>
                        </optgroup>
                        <optgroup label="Raw Materials">
                            <option value="iron">Iron</option>
                            <option value="wood">Wood</option>
                            <option value="coal">Coal</option>
                            <option value="resin">Resin</option>
                            <option value="fabric">Fabric</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantity:</label>
                    <input type="number" id="donationQuantity" min="1" placeholder="Enter amount" onchange="updateDonationPreview()">
                </div>
                
                <div id="donationPreview" style="display: none; padding: 10px; background: rgba(45, 90, 45, 0.1); border-radius: 5px; margin-bottom: 15px;">
                    <span style="color: #2d5a2d; font-weight: bold;">HC Earned: <span id="previewHC">0</span></span>
                    <span style="color: #5c4a3a; font-size: 12px; margin-left: 10px;">(Rate: <span id="previewRate">1.0</span>x)</span>
                </div>
                
                <div class="form-group">
                    <label>Storage Location:</label>
                    <select id="donationLocation">
                        <option value="">-- Select Location --</option>
                    </select>
                </div>
                
                <button class="btn btn-success" onclick="logResourceDonation()" style="width: 100%;">
                    Log Donation
                </button>
            </div>

            <div class="card">
                <h3>üìã Initialize Inventory</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Record existing officer holdings. Use for initial setup only. Does not affect Holding Coins.
                </p>
                
                <div class="form-group">
                    <label>Officer Holding Resources:</label>
                    <select id="initInventoryOfficer">
                        <option value="">-- Select Officer --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Resource Type:</label>
                    <select id="initInventoryResource">
                        <option value="">-- Select Resource --</option>
                        <optgroup label="Crafted Resources">
                            <option value="beams">Beams</option>
                            <option value="bulkheads">Bulkheads</option>
                            <option value="plates">Plates</option>
                            <option value="canvas">Canvas</option>
                        </optgroup>
                        <optgroup label="Raw Materials">
                            <option value="iron">Iron</option>
                            <option value="wood">Wood</option>
                            <option value="coal">Coal</option>
                            <option value="resin">Resin</option>
                            <option value="fabric">Fabric</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantity:</label>
                    <input type="number" id="initInventoryQuantity" min="1" placeholder="Enter amount">
                </div>
                
                <div class="form-group">
                    <label>Storage Location:</label>
                    <select id="initInventoryLocation">
                        <option value="">-- Select Location --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Note (required):</label>
                    <input type="text" id="initInventoryNote" placeholder="e.g., Initial inventory count">
                </div>
                
                <button class="btn btn-success" onclick="initializeInventory()" style="width: 100%;">
                    Add to Inventory
                </button>
            </div>

            <div class="card">
                <h3>ü§ù Transfer to Officer</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Transfer resources to another officer at the same location.
                </p>
                
                <div class="form-group">
                    <label>Resource Type:</label>
                    <select id="officerTransferResource">
                        <option value="">-- Select Resource --</option>
                        <optgroup label="Crafted Resources">
                            <option value="beams">Beams</option>
                            <option value="bulkheads">Bulkheads</option>
                            <option value="plates">Plates</option>
                            <option value="canvas">Canvas</option>
                        </optgroup>
                        <optgroup label="Raw Materials">
                            <option value="iron">Iron</option>
                            <option value="wood">Wood</option>
                            <option value="coal">Coal</option>
                            <option value="resin">Resin</option>
                            <option value="fabric">Fabric</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantity:</label>
                    <input type="number" id="officerTransferQuantity" min="1" placeholder="Enter amount">
                </div>
                
                <div class="form-group">
                    <label>Location:</label>
                    <select id="officerTransferLocation">
                        <option value="">-- Select Location --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Transfer To Officer:</label>
                    <select id="officerTransferTo">
                        <option value="">-- Select Officer --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Note (required):</label>
                    <input type="text" id="officerTransferNote" placeholder="e.g., Handing off for ship build">
                </div>
                
                <button class="btn btn-success" onclick="transferToOfficer()" style="width: 100%;">
                    Transfer to Officer
                </button>
            </div>

            <div class="card">
                <h3>üöö Transfer Location</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Move your resources from one port to another.
                </p>
                
                <div class="form-group">
                    <label>Resource Type:</label>
                    <select id="locationTransferResource">
                        <option value="">-- Select Resource --</option>
                        <optgroup label="Crafted Resources">
                            <option value="beams">Beams</option>
                            <option value="bulkheads">Bulkheads</option>
                            <option value="plates">Plates</option>
                            <option value="canvas">Canvas</option>
                        </optgroup>
                        <optgroup label="Raw Materials">
                            <option value="iron">Iron</option>
                            <option value="wood">Wood</option>
                            <option value="coal">Coal</option>
                            <option value="resin">Resin</option>
                            <option value="fabric">Fabric</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantity:</label>
                    <input type="number" id="locationTransferQuantity" min="1" placeholder="Enter amount">
                </div>
                
                <div class="form-group">
                    <label>From Location:</label>
                    <select id="locationTransferFrom">
                        <option value="">-- Select Location --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>To Location:</label>
                    <select id="locationTransferTo">
                        <option value="">-- Select Location --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Note (required):</label>
                    <input type="text" id="locationTransferNote" placeholder="e.g., Moving to shipyard">
                </div>
                
                <button class="btn btn-success" onclick="transferLocation()" style="width: 100%;">
                    Transfer Location
                </button>
            </div>

            <div class="card">
                <h3>üì§ Log Resource Distribution</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Record resources given to a player from guild storage.
                </p>
                
                <div class="form-group">
                    <label>Resource Type:</label>
                    <select id="distributionResource" onchange="updateDistributionSources()">
                        <option value="">-- Select Resource --</option>
                        <optgroup label="Crafted Resources">
                            <option value="beams">Beams</option>
                            <option value="bulkheads">Bulkheads</option>
                            <option value="plates">Plates</option>
                            <option value="canvas">Canvas</option>
                        </optgroup>
                        <optgroup label="Raw Materials">
                            <option value="iron">Iron</option>
                            <option value="coal">Coal</option>
                            <option value="wood">Wood</option>
                            <option value="resin">Resin</option>
                            <option value="fabric">Fabric</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>From Location:</label>
                    <select id="distributionLocation" onchange="updateDistributionSources()">
                        <option value="">-- Select Location --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>From Officer's Inventory:</label>
                    <select id="distributionFromOfficer">
                        <option value="">-- Select resource and location first --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantity:</label>
                    <input type="number" id="distributionQuantity" min="1" placeholder="Enter amount">
                </div>
                
                <div class="form-group">
                    <label>Recipient:</label>
                    <select id="distributionPlayer">
                        <option value="">-- Select Player --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Notes (optional):</label>
                    <input type="text" id="distributionNotes" placeholder="e.g., Shop purchase, alliance order">
                </div>
                
                <button class="btn btn-success" onclick="logDistribution()" style="width: 100%;">
                    Log Distribution
                </button>
            </div>

            <div class="card">
                <h3>üî® Log Crafting</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Record crafting of materials. Raw materials consumed will be deducted and crafted materials added to your inventory.
                </p>
                
                <div class="form-group">
                    <label>Crafting Location:</label>
                    <select id="craftingLocation">
                        <option value="">-- Select Location --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Crafted Material:</label>
                    <select id="craftedMaterial">
                        <option value="">-- Select Material --</option>
                        <option value="beams">Beams</option>
                        <option value="bulkheads">Bulkheads</option>
                        <option value="plates">Plates</option>
                        <option value="canvas">Canvas</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantity Produced:</label>
                    <input type="number" id="craftedQuantity" min="1" placeholder="Enter amount crafted">
                </div>
                
                <div class="form-group">
                    <label>Raw Materials Consumed:</label>
                    <div class="crafting-inputs">
                        <div class="crafting-input-row">
                            <span class="crafting-label">Wood:</span>
                            <input type="number" id="craftWood" min="0" placeholder="0">
                        </div>
                        <div class="crafting-input-row">
                            <span class="crafting-label">Iron:</span>
                            <input type="number" id="craftIron" min="0" placeholder="0">
                        </div>
                        <div class="crafting-input-row">
                            <span class="crafting-label">Coal:</span>
                            <input type="number" id="craftCoal" min="0" placeholder="0">
                        </div>
                        <div class="crafting-input-row">
                            <span class="crafting-label">Resin:</span>
                            <input type="number" id="craftResin" min="0" placeholder="0">
                        </div>
                        <div class="crafting-input-row">
                            <span class="crafting-label">Fabric:</span>
                            <input type="number" id="craftFabric" min="0" placeholder="0">
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="logCrafting()" style="width: 100%;">
                    Log Crafting
                </button>
            </div>

            <div class="card">
                <h3>üëë Manage Officers</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Promote or demote players to officer status.
                </p>
                
                <div class="form-group">
                    <label>Select Player:</label>
                    <select id="officerPlayer">
                        <option value="">-- Select Player --</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="promoteToOfficer()" style="flex: 1;">
                        Promote to Officer
                    </button>
                    <button class="btn btn-danger" onclick="demoteOfficer()" style="flex: 1;">
                        Remove Officer
                    </button>
                </div>
            </div>

            <div class="card">
                <h3>üö¢ Manage Admirals</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Promote or demote players to guild admiral status.
                </p>
                
                <div class="form-group">
                    <label>Select Player:</label>
                    <select id="admiralPlayer">
                        <option value="">-- Select Player --</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="promoteToAdmiral()" style="flex: 1;">
                        Promote to Admiral
                    </button>
                    <button class="btn btn-danger" onclick="demoteAdmiral()" style="flex: 1;">
                        Remove Admiral
                    </button>
                </div>
            </div>

            <div class="card">
                <h3>‚öì Change Player Guild</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Reassign a player to a different guild.
                </p>
                
                <div class="form-group">
                    <label>Select Player:</label>
                    <select id="guildChangePlayer">
                        <option value="">-- Select Player --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>New Guild:</label>
                    <select id="newGuildSelect">
                        <option value="">-- Select Guild --</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" onclick="changePlayerGuild()" style="width: 100%;">
                    Change Guild
                </button>
            </div>

            <div class="card">
                <h3>üè¥ Manage Trade Partners</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Trade partners can place ship orders. Members earn gold fulfilling orders.
                </p>
                <div id="guildAllianceList">
                    <div style="text-align: center; color: #5c4a3a;">Loading guilds...</div>
                </div>
            </div>

            <div class="card">
                <h3>üí∞ Exchange Rates</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Set HC rates for donations. Higher rates attract more donations of needed resources.
                </p>
                <div id="exchangeRatesList">
                    <div style="text-align: center; color: #5c4a3a;">Loading rates...</div>
                </div>
                <button class="btn btn-primary" onclick="saveExchangeRates()" style="width: 100%; margin-top: 15px;">
                    Save Exchange Rates
                </button>
            </div>
        </div>

        <div class="card">
            <h3>üë• All Members</h3>
            <div style="overflow-x: auto;">
                <table id="membersTable">
                    <thead>
                        <tr>
                            <th>Gamertag</th>
                            <th>Total HC</th>
                            <th>Spent</th>
                            <th>Balance</th>
                            <th>Forts</th>
                            <th>Last Activity</th>
                            <th>Details</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="card-grid">
            <div class="card">
                <h3>üè¶ Guild Resources</h3>
                <div id="resourcesDisplay"></div>
            </div>

            <div class="card">
                <h3>üìú Admiral's Ledger</h3>
                <p style="color: #5c4a3a; margin-bottom: 15px; font-size: 13px;">
                    Log of all officer actions.
                </p>
                <div class="ledger-container" id="ledgerContainer">
                    <div style="text-align: center; color: #5c4a3a;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="removeContributionModal">
        <div class="modal">
            <h3>üóëÔ∏è Remove Contribution</h3>
            <div id="contributionsList" class="contributions-list"></div>
            <div class="form-group" style="margin-top: 15px;">
                <label>Justification (required):</label>
                <textarea id="removeJustification" placeholder="Explain why this entry is being removed..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="closeRemoveModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmRemoveContribution()">Remove Selected</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        let allMembers = [];
        let allGuilds = [];
        let allLocations = [];
        let currentOfficer = null;
        let selectedPlayerId = null;
        let selectedContributionId = null;
        let exchangeRates = {};

        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                const playerDoc = await db.collection('players').doc(user.uid).get();
                if (!playerDoc.exists || !playerDoc.data().isOfficer) {
                    alert('Access denied. Officers only.');
                    window.location.href = 'dashboard.html';
                    return;
                }
                currentOfficer = { id: user.uid, ...playerDoc.data() };

                if (currentOfficer.isAdmiral) {
                    document.getElementById('guildNav').style.display = 'inline-block';
                }

                loadAdminData();
            }
        });

        async function loadAdminData() {
            try {
                const guildsSnapshot = await db.collection('guilds').orderBy('name').get();
                allGuilds = guildsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateGuildSelector();

                const locationsSnapshot = await db.collection('locations').where('isActive', '==', true).get();
                allLocations = locationsSnapshot.docs.map(doc => ({ code: doc.id, ...doc.data() }));
                allLocations.sort((a, b) => a.name.localeCompare(b.name));
                populateLocationSelectors();

                const ratesSnapshot = await db.collection('guildResources').get();
                ratesSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const key = data.materialType.toLowerCase();
                    exchangeRates[key] = {
                        base: data.baseHCValue || POINT_VALUES[key.toUpperCase()] || 1,
                        current: data.currentHCValue || data.baseHCValue || POINT_VALUES[key.toUpperCase()] || 1,
                        multiplier: data.rateMultiplier || 1.0
                    };
                });
                displayExchangeRates();

                db.collection('players')
                    .orderBy('totalPoints', 'desc')
                    .onSnapshot(snapshot => {
                        allMembers = snapshot.docs;
                        displayMembers(snapshot.docs);
                        updateParticipantLists(snapshot.docs);
                        displayGuildAlliances();
                    });

                db.collection('officerInventory')
                    .onSnapshot(snapshot => {
                        displayResourcesWithOfficers(snapshot.docs);
                    });

                db.collection('admiralLedger')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .onSnapshot(snapshot => {
                        displayLedger(snapshot.docs);
                    });

                document.getElementById('loading').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';

            } catch (err) {
                console.error('Error loading admin data:', err);
                alert('Error: ' + err.message);
            }
        }

        function populateGuildSelector() {
            const selector = document.getElementById('newGuildSelect');
            selector.innerHTML = '<option value="">-- Select Guild --</option>';
            
            allGuilds.forEach(guild => {
                const option = document.createElement('option');
                option.value = guild.code;
                option.textContent = guild.name;
                selector.appendChild(option);
            });
        }

        function populateLocationSelectors() {
            const selectors = [
                'donationLocation',
                'initInventoryLocation',
                'distributionLocation',
                'craftingLocation',
                'officerTransferLocation',
                'locationTransferFrom',
                'locationTransferTo'
            ];
            
            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (!selector) return;
                
                selector.innerHTML = '<option value="">-- Select Location --</option>';
                allLocations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc.code;
                    option.textContent = loc.name;
                    selector.appendChild(option);
                });
            });
        }

        function displayMembers(docs) {
            const tbody = document.querySelector('#membersTable tbody');
            tbody.innerHTML = '';

            docs.forEach(doc => {
                const member = doc.data();
                const balance = (member.totalPoints || 0) - (member.sharesRedeemed || 0);

                let lastActivityText = 'Never';
                if (member.lastActivity) {
                    const lastActivity = member.lastActivity.toDate();
                    const daysAgo = Math.floor((Date.now() - lastActivity) / (1000 * 60 * 60 * 24));
                    lastActivityText = daysAgo === 0 ? 'Today' : `${daysAgo}d ago`;
                }

                const squadronPrefix = member.squadron ? `[${member.squadron}] ` : '';
                const officerBadge = member.isOfficer ? '<span class="officer-badge">OFFICER</span>' : '';
                const admiralBadge = member.isAdmiral ? '<span class="admiral-badge">ADMIRAL</span>' : '';

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="gamertag">${member.gamertag ? squadronPrefix + member.gamertag : '-'}</span>${officerBadge}${admiralBadge}</td>
                    <td>${formatNumber(member.totalPoints || 0)}</td>
                    <td>${formatNumber(member.sharesRedeemed || 0)}</td>
                    <td>${formatNumber(balance)}</td>
                    <td>${member.fortsDestroyed || 0}</td>
                    <td>${lastActivityText}</td>
                    <td>
                        <button class="btn btn-small btn-primary" onclick="toggleMemberDetails('${doc.id}', this)">
                            Expand
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-small btn-warning" onclick="openRemoveModal('${doc.id}')">
                            Manage
                        </button>
                    </td>
                `;
            });
        }

        function updateParticipantLists(docs) {
            const fortContainer = document.getElementById('fortParticipantsList');
            fortContainer.innerHTML = '';

            const donationSelector = document.getElementById('donationPlayer');
            donationSelector.innerHTML = '<option value="">-- Select Player --</option>';

            const officerSelector = document.getElementById('officerPlayer');
            officerSelector.innerHTML = '<option value="">-- Select Player --</option>';

            const initOfficerSelector = document.getElementById('initInventoryOfficer');
            initOfficerSelector.innerHTML = '<option value="">-- Select Officer --</option>';

            const officerTransferSelector = document.getElementById('officerTransferTo');
            officerTransferSelector.innerHTML = '<option value="">-- Select Officer --</option>';

            const admiralSelector = document.getElementById('admiralPlayer');
            admiralSelector.innerHTML = '<option value="">-- Select Player --</option>';

            const guildChangeSelector = document.getElementById('guildChangePlayer');
            guildChangeSelector.innerHTML = '<option value="">-- Select Player --</option>';

            const distributionSelector = document.getElementById('distributionPlayer');
            distributionSelector.innerHTML = '<option value="">-- Select Player --</option>';

            docs.forEach(doc => {
                const member = doc.data();
                const squadronPrefix = member.squadron ? `[${member.squadron}] ` : '';
                const displayText = member.gamertag ? squadronPrefix + member.gamertag : 'No gamertag';
                
                const label = document.createElement('label');
                label.innerHTML = `
                    <input type="checkbox" class="fort-participant" value="${doc.id}">
                    ${displayText}
                    <span style="color: #5c4a3a; font-size: 11px;">(${member.fortsDestroyed || 0} forts)</span>
                `;
                fortContainer.appendChild(label);

                const donationOption = document.createElement('option');
                donationOption.value = doc.id;
                donationOption.textContent = displayText;
                donationSelector.appendChild(donationOption);

                const officerOption = document.createElement('option');
                officerOption.value = doc.id;
                officerOption.textContent = displayText + (member.isOfficer ? ' (Officer)' : '');
                officerSelector.appendChild(officerOption);

                const admiralOption = document.createElement('option');
                admiralOption.value = doc.id;
                admiralOption.textContent = displayText + (member.isAdmiral ? ' (Admiral)' : '');
                admiralSelector.appendChild(admiralOption);

                const guildChangeOption = document.createElement('option');
                guildChangeOption.value = doc.id;
                guildChangeOption.textContent = displayText;
                guildChangeSelector.appendChild(guildChangeOption);

                const distOption = document.createElement('option');
                distOption.value = doc.id;
                distOption.textContent = displayText;
                distributionSelector.appendChild(distOption);

                if (member.isOfficer) {
                    const initOfficerOption = document.createElement('option');
                    initOfficerOption.value = doc.id;
                    initOfficerOption.textContent = displayText;
                    initOfficerSelector.appendChild(initOfficerOption);
                }

                if (member.isOfficer && doc.id !== currentOfficer.id) {
                    const transferOption = document.createElement('option');
                    transferOption.value = doc.id;
                    transferOption.textContent = displayText;
                    officerTransferSelector.appendChild(transferOption);
                }
            });
        }

        function toggleSelectAll(type) {
            const selectAll = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`).checked;
            const checkboxes = document.querySelectorAll(`.${type}-participant`);
            checkboxes.forEach(cb => cb.checked = selectAll);
        }

        function displayExchangeRates() {
            const container = document.getElementById('exchangeRatesList');
            
            const resources = [
                { name: 'Beams', key: 'beams', base: 1.0 },
                { name: 'Bulkheads', key: 'bulkheads', base: 2.0 },
                { name: 'Plates', key: 'plates', base: 2.0 },
                { name: 'Canvas', key: 'canvas', base: 1.0 },
                { name: 'Iron', key: 'iron', base: 0.01 },
                { name: 'Wood', key: 'wood', base: 0.001 },
                { name: 'Coal', key: 'coal', base: 0.01 },
                { name: 'Resin', key: 'resin', base: 0.005 },
                { name: 'Fabric', key: 'fabric', base: 0.0005 }
            ];
            
            container.innerHTML = resources.map(r => {
                const rate = exchangeRates[r.key] || { current: r.base, multiplier: 1.0 };
                const multiplier = rate.multiplier || 1.0;
                let rateClass = 'rate-normal';
                let rateLabel = '1.0x';
                
                if (multiplier >= 2.0) {
                    rateClass = 'rate-critical';
                    rateLabel = multiplier.toFixed(1) + 'x CRITICAL';
                } else if (multiplier >= 1.5) {
                    rateClass = 'rate-needed';
                    rateLabel = multiplier.toFixed(1) + 'x NEEDED';
                } else if (multiplier <= 0.5) {
                    rateClass = 'rate-surplus';
                    rateLabel = multiplier.toFixed(1) + 'x SURPLUS';
                } else {
                    rateLabel = multiplier.toFixed(1) + 'x';
                }
                
                return `
                    <div class="rate-item">
                        <span class="rate-resource">${r.name}</span>
                        <div class="rate-value">
                            <input type="number" 
                                class="rate-input" 
                                id="rate_${r.key}" 
                                value="${multiplier.toFixed(1)}" 
                                min="0.1" 
                                max="5.0" 
                                step="0.1">
                            <span class="rate-multiplier ${rateClass}">${rateLabel}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function saveExchangeRates() {
            const resources = ['beams', 'bulkheads', 'plates', 'canvas', 'iron', 'wood', 'coal', 'resin', 'fabric'];
            
            try {
                const batch = db.batch();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                
                for (const key of resources) {
                    const input = document.getElementById(`rate_${key}`);
                    if (!input) continue;
                    
                    const multiplier = parseFloat(input.value) || 1.0;
                    const resourceName = key.charAt(0).toUpperCase() + key.slice(1);
                    
                    const resourceQuery = await db.collection('guildResources')
                        .where('materialType', '==', resourceName)
                        .get();
                    
                    if (!resourceQuery.empty) {
                        const baseValue = POINT_VALUES[key.toUpperCase()] || 1;
                        batch.update(resourceQuery.docs[0].ref, {
                            rateMultiplier: multiplier,
                            currentHCValue: baseValue * multiplier,
                            baseHCValue: baseValue,
                            rateSetBy: currentOfficer.id,
                            rateSetAt: timestamp
                        });
                        
                        exchangeRates[key] = {
                            base: baseValue,
                            current: baseValue * multiplier,
                            multiplier: multiplier
                        };
                    }
                }
                
                await batch.commit();
                
                await logToLedger(
                    'Exchange Rates Updated',
                    `Exchange rates updated by officer`
                );
                
                displayExchangeRates();
                alert('Exchange rates saved!');
                
            } catch (err) {
                console.error('Error saving exchange rates:', err);
                alert('Error: ' + err.message);
            }
        }

        function updateDonationPreview() {
            const resourceType = document.getElementById('donationResource').value;
            const quantity = parseInt(document.getElementById('donationQuantity').value) || 0;
            const preview = document.getElementById('donationPreview');
            
            if (!resourceType || quantity < 1) {
                preview.style.display = 'none';
                return;
            }
            
            const rate = exchangeRates[resourceType] || { current: POINT_VALUES[resourceType.toUpperCase()] || 1, multiplier: 1.0 };
            const hcEarned = parseFloat((rate.current * quantity).toFixed(2));
            
            document.getElementById('previewHC').textContent = formatNumber(hcEarned);
            document.getElementById('previewRate').textContent = rate.multiplier.toFixed(1);
            preview.style.display = 'block';
        }

        function displayLedger(docs) {
            const container = document.getElementById('ledgerContainer');
            
            if (docs.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #5c4a3a;">No entries yet</div>';
                return;
            }

            container.innerHTML = '';

            docs.forEach(doc => {
                const entry = doc.data();
                let actionClass = 'action-add';
                if (entry.action.includes('Remove') || entry.action.includes('Demote')) {
                    actionClass = 'action-remove';
                } else if (entry.action.includes('Officer') || entry.action.includes('Promote')) {
                    actionClass = 'action-officer';
                }

                const timestamp = entry.timestamp ? entry.timestamp.toDate().toLocaleString() : 'Unknown';

                const entryDiv = document.createElement('div');
                entryDiv.className = 'ledger-entry';
                entryDiv.innerHTML = `
                    <div class="ledger-action ${actionClass}">${entry.action}</div>
                    <div class="ledger-details">${entry.details || ''}</div>
                    ${entry.justification ? `<div class="ledger-justification">"${entry.justification}"</div>` : ''}
                    <div class="ledger-meta">By ${entry.performedByName || 'Unknown'} ‚Ä¢ ${timestamp}</div>
                `;
                container.appendChild(entryDiv);
            });
        }

        async function logToLedger(action, details, justification = null) {
            try {
                await db.collection('admiralLedger').add({
                    action: action,
                    details: details,
                    justification: justification,
                    performedBy: currentOfficer.id,
                    performedByName: currentOfficer.gamertag || currentOfficer.displayName || 'Unknown',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (err) {
                console.error('Error logging to ledger:', err);
            }
        }

        async function logFortRaid() {
            const checkboxes = document.querySelectorAll('.fort-participant:checked');
            
            if (checkboxes.length === 0) {
                alert('Select at least one participant');
                return;
            }

            try {
                const batch = db.batch();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                const participantNames = [];

                for (const checkbox of checkboxes) {
                    const playerId = checkbox.value;
                    const playerDoc = allMembers.find(m => m.id === playerId);
                    const playerData = playerDoc ? playerDoc.data() : {};
                    const playerName = playerData.gamertag || 'Unknown';
                    participantNames.push(playerName);

                    const playerRef = db.collection('players').doc(playerId);
                    
                    batch.update(playerRef, {
                        totalPoints: firebase.firestore.FieldValue.increment(POINT_VALUES.FORT_RAID),
                        fortsDestroyed: firebase.firestore.FieldValue.increment(1),
                        lastActivity: timestamp
                    });
                    
                    const contribRef = db.collection('contributions').doc();
                    batch.set(contribRef, {
                        playerId: playerId,
                        playerName: playerName,
                        activityType: 'Fort Raid',
                        pointsEarned: POINT_VALUES.FORT_RAID,
                        materialType: null,
                        materialQuantity: null,
                        notes: 'Fort raid logged by officer',
                        loggedBy: currentOfficer.id,
                        loggedByName: currentOfficer.gamertag || currentOfficer.displayName,
                        createdAt: timestamp
                    });
                }

                await batch.commit();
                
                await logToLedger(
                    'Fort Raid Logged',
                    `${checkboxes.length} participants: ${participantNames.join(', ')} (+${POINT_VALUES.FORT_RAID} HC each)`
                );
                
                alert(`Fort raid logged! ${checkboxes.length} participants awarded ${POINT_VALUES.FORT_RAID} Holding Coins each.`);
                
                checkboxes.forEach(cb => cb.checked = false);
                document.getElementById('selectAllFort').checked = false;

            } catch (err) {
                console.error('Error logging fort raid:', err);
                alert('Error: ' + err.message);
            }
        }

        async function logResourceDonation() {
            const playerId = document.getElementById('donationPlayer').value;
            const resourceType = document.getElementById('donationResource').value;
            const quantity = parseInt(document.getElementById('donationQuantity').value);
            const location = document.getElementById('donationLocation').value;

            if (!playerId) { alert('Select a player'); return; }
            if (!resourceType) { alert('Select a resource type'); return; }
            if (!quantity || quantity < 1) { alert('Enter a valid quantity'); return; }
            if (!location) { alert('Select a storage location'); return; }

            const rate = exchangeRates[resourceType] || { current: POINT_VALUES[resourceType.toUpperCase()] || 0 };
            const pointValue = rate.current;
            
            if (pointValue === 0) { alert('Unknown resource type'); return; }

            const pointsEarned = parseFloat((pointValue * quantity).toFixed(2));
            
            if (pointsEarned < 0.01) {
                alert(`Quantity too low to earn Holding Coins.`);
                return;
            }

            const playerDoc = allMembers.find(m => m.id === playerId);
            const playerData = playerDoc ? playerDoc.data() : {};
            const playerName = playerData.gamertag || 'Unknown';
            
            const locationData = allLocations.find(l => l.code === location);
            const locationName = locationData ? locationData.name : location;

            const officerName = currentOfficer.gamertag || 'Unknown';
            const officerSquadron = currentOfficer.squadron ? `[${currentOfficer.squadron}] ` : '';

            try {
                const batch = db.batch();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                const playerRef = db.collection('players').doc(playerId);
                batch.update(playerRef, {
                    totalPoints: firebase.firestore.FieldValue.increment(pointsEarned),
                    lastActivity: timestamp
                });

                const contribRef = db.collection('contributions').doc();
                batch.set(contribRef, {
                    playerId: playerId,
                    playerName: playerName,
                    activityType: 'Material Donation',
                    pointsEarned: pointsEarned,
                    materialType: resourceType,
                    materialQuantity: quantity,
                    location: location,
                    rateMultiplier: exchangeRates[resourceType]?.multiplier || 1.0,
                    notes: `Donated ${formatNumber(quantity)} ${resourceType} at ${locationName}`,
                    loggedBy: currentOfficer.id,
                    loggedByName: officerSquadron + officerName,
                    createdAt: timestamp
                });

                const guildStorageResources = ['beams', 'bulkheads', 'plates', 'canvas', 'iron', 'wood', 'coal', 'resin', 'fabric'];
                if (guildStorageResources.includes(resourceType)) {
                    const resourceName = resourceType.charAt(0).toUpperCase() + resourceType.slice(1);
                    const resourceQuery = await db.collection('guildResources')
                        .where('materialType', '==', resourceName)
                        .get();
                    
                    if (!resourceQuery.empty) {
                        const resourceRef = resourceQuery.docs[0].ref;
                        batch.update(resourceRef, {
                            currentStock: firebase.firestore.FieldValue.increment(quantity),
                            lastUpdated: timestamp,
                            updatedBy: currentOfficer.id
                        });
                    }
                }

                const inventoryId = `${currentOfficer.id}_${resourceType}_${location}`;
                const inventoryRef = db.collection('officerInventory').doc(inventoryId);
                const existingInventory = await inventoryRef.get();
                
                if (existingInventory.exists) {
                    batch.update(inventoryRef, {
                        quantity: firebase.firestore.FieldValue.increment(quantity),
                        lastUpdated: timestamp
                    });
                } else {
                    batch.set(inventoryRef, {
                        officerId: currentOfficer.id,
                        resourceType: resourceType,
                        location: location,
                        quantity: quantity,
                        lastUpdated: timestamp
                    });
                }

                await batch.commit();

                const rateInfo = exchangeRates[resourceType]?.multiplier !== 1.0 
                    ? ` (${exchangeRates[resourceType].multiplier.toFixed(1)}x rate)` 
                    : '';

                await logToLedger(
                    'Resource Donation Logged',
                    `${playerName} donated ${formatNumber(quantity)} ${resourceType}. Stored by ${officerSquadron}${officerName} at ${locationName}. (+${pointsEarned} HC${rateInfo})`
                );

                alert(`Donation logged!\n${formatNumber(quantity)} ${resourceType} = ${pointsEarned} Holding Coins\nStored at ${locationName}`);

                document.getElementById('donationPlayer').value = '';
                document.getElementById('donationResource').value = '';
                document.getElementById('donationQuantity').value = '';
                document.getElementById('donationLocation').value = '';
                document.getElementById('donationPreview').style.display = 'none';

            } catch (err) {
                console.error('Error logging donation:', err);
                alert('Error: ' + err.message);
            }
        }

        async function promoteToOfficer() {
            const playerId = document.getElementById('officerPlayer').value;
            if (!playerId) { alert('Select a player'); return; }

            const playerDoc = allMembers.find(m => m.id === playerId);
            const playerData = playerDoc ? playerDoc.data() : {};
            
            if (playerData.isOfficer) { alert('This player is already an officer'); return; }

            const playerName = playerData.gamertag || 'Unknown';

            if (!confirm(`Promote ${playerName} to Officer?`)) return;

            try {
                await db.collection('players').doc(playerId).update({ isOfficer: true });
                await logToLedger('Officer Promoted', `${playerName} was promoted to Officer`);
                alert(`${playerName} is now an Officer!`);
                document.getElementById('officerPlayer').value = '';
            } catch (err) {
                console.error('Error promoting officer:', err);
                alert('Error: ' + err.message);
            }
        }

        async function demoteOfficer() {
            const playerId = document.getElementById('officerPlayer').value;
            if (!playerId) { alert('Select a player'); return; }

            const playerDoc = allMembers.find(m => m.id === playerId);
            const playerData = playerDoc ? playerDoc.data() : {};
            
            if (!playerData.isOfficer) { alert('This player is not an officer'); return; }
            if (playerId === currentOfficer.id) { alert('You cannot demote yourself'); return; }

            const playerName = playerData.gamertag || 'Unknown';

            if (!confirm(`Remove Officer status from ${playerName}?`)) return;

            try {
                await db.collection('players').doc(playerId).update({ isOfficer: false });
                await logToLedger('Officer Demoted', `${playerName} was removed as Officer`);
                alert(`${playerName} is no longer an Officer`);
                document.getElementById('officerPlayer').value = '';
            } catch (err) {
                console.error('Error demoting officer:', err);
                alert('Error: ' + err.message);
            }
        }

        async function openRemoveModal(playerId) {
            selectedPlayerId = playerId;
            const playerDoc = allMembers.find(m => m.id === playerId);
            const playerData = playerDoc ? playerDoc.data() : {};
            const playerName = playerData.gamertag || 'Unknown';

            const contributionsSnapshot = await db.collection('contributions')
                .where('playerId', '==', playerId)
                .orderBy('createdAt', 'desc')
                .limit(20)
                .get();

            const container = document.getElementById('contributionsList');
            
            if (contributionsSnapshot.empty) {
                container.innerHTML = `<p style="text-align: center; color: #5c4a3a;">No contributions found for ${playerName}</p>`;
            } else {
                container.innerHTML = `<p style="margin-bottom: 10px; color: #8b6914; font-weight: bold;">Contributions for ${playerName}:</p>`;
                
                contributionsSnapshot.docs.forEach(doc => {
                    const contrib = doc.data();
                    const date = contrib.createdAt ? contrib.createdAt.toDate().toLocaleDateString() : 'Unknown';
                    
                    const item = document.createElement('div');
                    item.className = 'contribution-item';
                    item.innerHTML = `
                        <input type="radio" name="selectedContribution" value="${doc.id}" style="margin-right: 10px; accent-color: #8b6914;">
                        <div class="contribution-info">
                            <div class="contribution-type">${contrib.activityType}</div>
                            <div class="contribution-details">
                                ${contrib.materialType ? `${contrib.materialQuantity} ${contrib.materialType} ‚Ä¢ ` : ''}
                                +${contrib.pointsEarned} HC ‚Ä¢ ${date}
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }

            document.getElementById('removeJustification').value = '';
            document.getElementById('removeContributionModal').classList.add('active');
        }

        function closeRemoveModal() {
            document.getElementById('removeContributionModal').classList.remove('active');
            selectedPlayerId = null;
        }

        async function confirmRemoveContribution() {
            const selectedRadio = document.querySelector('input[name="selectedContribution"]:checked');
            if (!selectedRadio) { alert('Select a contribution to remove'); return; }

            const justification = document.getElementById('removeJustification').value.trim();
            if (!justification) { alert('Justification is required'); return; }

            const contributionId = selectedRadio.value;

            try {
                const contribDoc = await db.collection('contributions').doc(contributionId).get();
                if (!contribDoc.exists) { alert('Contribution not found'); return; }

                const contrib = contribDoc.data();
                const playerDoc = allMembers.find(m => m.id === contrib.playerId);
                const playerData = playerDoc ? playerDoc.data() : {};
                const playerName = playerData.gamertag || contrib.playerName || 'Unknown';

                if (!confirm(`Remove this ${contrib.activityType} entry?\n\nThis will deduct ${contrib.pointsEarned} Holding Coins from ${playerName}.`)) {
                    return;
                }

                const batch = db.batch();

                const playerRef = db.collection('players').doc(contrib.playerId);
                const updateData = {
                    totalPoints: firebase.firestore.FieldValue.increment(-contrib.pointsEarned)
                };

                if (contrib.activityType === 'Fort Raid') {
                    updateData.fortsDestroyed = firebase.firestore.FieldValue.increment(-1);
                }

                batch.update(playerRef, updateData);

                if (contrib.materialType && contrib.materialQuantity) {
                    const guildStorageResources = ['beams', 'bulkheads', 'plates', 'canvas', 'iron', 'wood', 'resin', 'fabric', 'coal'];
                    if (guildStorageResources.includes(contrib.materialType.toLowerCase())) {
                        const resourceName = contrib.materialType.charAt(0).toUpperCase() + contrib.materialType.slice(1);
                        const resourceQuery = await db.collection('guildResources')
                            .where('materialType', '==', resourceName)
                            .get();
                        
                        if (!resourceQuery.empty) {
                            batch.update(resourceQuery.docs[0].ref, {
                                currentStock: firebase.firestore.FieldValue.increment(-contrib.materialQuantity)
                            });
                        }
                    }

                    if (contrib.loggedBy && contrib.location) {
                        const inventoryId = `${contrib.loggedBy}_${contrib.materialType.toLowerCase()}_${contrib.location}`;
                        const inventoryRef = db.collection('officerInventory').doc(inventoryId);
                        const inventoryDoc = await inventoryRef.get();
                        
                        if (inventoryDoc.exists) {
                            batch.update(inventoryRef, {
                                quantity: firebase.firestore.FieldValue.increment(-contrib.materialQuantity),
                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }
                }

                batch.delete(db.collection('contributions').doc(contributionId));

                await batch.commit();

                await logToLedger(
                    'Contribution Removed',
                    `Removed ${contrib.activityType} from ${playerName} (-${contrib.pointsEarned} HC)${contrib.materialType ? ` ‚Ä¢ ${contrib.materialQuantity} ${contrib.materialType} returned` : ''}`,
                    justification
                );

                alert('Contribution removed successfully');
                closeRemoveModal();

            } catch (err) {
                console.error('Error removing contribution:', err);
                alert('Error: ' + err.message);
            }
        }

        async function logDistribution() {
            const resourceType = document.getElementById('distributionResource').value;
            const location = document.getElementById('distributionLocation').value;
            const fromOfficerId = document.getElementById('distributionFromOfficer').value;
            const quantity = parseInt(document.getElementById('distributionQuantity').value);
            const playerId = document.getElementById('distributionPlayer').value;
            const notes = document.getElementById('distributionNotes').value.trim();

            if (!resourceType) { alert('Select a resource type'); return; }
            if (!location) { alert('Select a location'); return; }
            if (!fromOfficerId) { alert('Select which officer inventory to draw from'); return; }
            if (!quantity || quantity < 1) { alert('Enter a valid quantity'); return; }
            if (!playerId) { alert('Select a recipient'); return; }

            const inventoryId = `${fromOfficerId}_${resourceType}_${location}`;
            const inventoryDoc = await db.collection('officerInventory').doc(inventoryId).get();
            
            if (!inventoryDoc.exists || inventoryDoc.data().quantity < quantity) {
                const available = inventoryDoc.exists ? inventoryDoc.data().quantity : 0;
                alert(`Insufficient inventory. Only ${formatNumber(available)} available.`);
                updateDistributionSources();
                return;
            }

            const playerDoc = allMembers.find(m => m.id === playerId);
            const playerData = playerDoc ? playerDoc.data() : {};
            const playerName = playerData.gamertag || 'Unknown';
            const playerSquadronPrefix = playerData.squadron ? `[${playerData.squadron}] ` : '';

            const fromOfficerDoc = allMembers.find(m => m.id === fromOfficerId);
            const fromOfficerData = fromOfficerDoc ? fromOfficerDoc.data() : {};
            const fromOfficerName = fromOfficerData.gamertag || 'Unknown';
            const fromOfficerSquadron = fromOfficerData.squadron ? `[${fromOfficerData.squadron}] ` : '';

            const performingOfficerName = currentOfficer.squadron 
                ? `[${currentOfficer.squadron}] ${currentOfficer.gamertag}`
                : currentOfficer.gamertag;

            const resourceDisplay = resourceType.charAt(0).toUpperCase() + resourceType.slice(1);
            const locationData = allLocations.find(l => l.code === location);
            const locationName = locationData ? locationData.name : location;

            try {
                const batch = db.batch();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                const distRef = db.collection('distributions').doc();
                batch.set(distRef, {
                    playerId: playerId,
                    playerName: playerSquadronPrefix + playerName,
                    resourceType: resourceType,
                    quantity: quantity,
                    location: location,
                    fromOfficerId: fromOfficerId,
                    fromOfficerName: fromOfficerSquadron + fromOfficerName,
                    performedBy: currentOfficer.id,
                    performedByName: performingOfficerName,
                    timestamp: timestamp,
                    notes: notes || null
                });

                const guildStorageResources = ['beams', 'bulkheads', 'plates', 'canvas', 'iron', 'wood', 'coal', 'resin', 'fabric'];
                if (guildStorageResources.includes(resourceType)) {
                    const resourceQuery = await db.collection('guildResources')
                        .where('materialType', '==', resourceDisplay)
                        .get();
                    
                    if (!resourceQuery.empty) {
                        batch.update(resourceQuery.docs[0].ref, {
                            currentStock: firebase.firestore.FieldValue.increment(-quantity),
                            lastUpdated: timestamp,
                            updatedBy: currentOfficer.id
                        });
                    }
                }

                const inventoryRef = db.collection('officerInventory').doc(inventoryId);
                batch.update(inventoryRef, {
                    quantity: firebase.firestore.FieldValue.increment(-quantity),
                    lastUpdated: timestamp
                });

                const ledgerRef = db.collection('admiralLedger').doc();
                batch.set(ledgerRef, {
                    action: 'Resource Distribution',
                    details: `${formatNumber(quantity)} ${resourceDisplay} given to ${playerSquadronPrefix}${playerName} from ${fromOfficerSquadron}${fromOfficerName}'s inventory at ${locationName}${notes ? ' - ' + notes : ''}`,
                    performedBy: currentOfficer.id,
                    performedByName: performingOfficerName,
                    timestamp: timestamp
                });

                await batch.commit();

                alert(`Distribution logged!\n${formatNumber(quantity)} ${resourceDisplay} given to ${playerName}\nFrom: ${fromOfficerName}'s inventory at ${locationName}`);

                document.getElementById('distributionResource').value = '';
                document.getElementById('distributionLocation').value = '';
                document.getElementById('distributionFromOfficer').innerHTML = '<option value="">-- Select resource and location first --</option>';
                document.getElementById('distributionQuantity').value = '';
                document.getElementById('distributionPlayer').value = '';
                document.getElementById('distributionNotes').value = '';

            } catch (err) {
                console.error('Error logging distribution:', err);
                alert('Error: ' + err.message);
            }
        }

        async function logCrafting() {
            const location = document.getElementById('craftingLocation').value;
            const craftedMaterial = document.getElementById('craftedMaterial').value;
            const craftedQuantity = parseInt(document.getElementById('craftedQuantity').value);
            
            const woodUsed = parseInt(document.getElementById('craftWood').value) || 0;
            const ironUsed = parseInt(document.getElementById('craftIron').value) || 0;
            const coalUsed = parseInt(document.getElementById('craftCoal').value) || 0;
            const resinUsed = parseInt(document.getElementById('craftResin').value) || 0;
            const fabricUsed = parseInt(document.getElementById('craftFabric').value) || 0;

            if (!location) { alert('Select a crafting location'); return; }
            if (!craftedMaterial) { alert('Select a crafted material'); return; }
            if (!craftedQuantity || craftedQuantity < 1) { alert('Enter the quantity produced'); return; }
            
            const totalRawUsed = woodUsed + ironUsed + coalUsed + resinUsed + fabricUsed;
            if (totalRawUsed === 0) { alert('Enter at least one raw material consumed'); return; }

            const rawMaterialsNeeded = [
                { type: 'wood', amount: woodUsed },
                { type: 'iron', amount: ironUsed },
                { type: 'coal', amount: coalUsed },
                { type: 'resin', amount: resinUsed },
                { type: 'fabric', amount: fabricUsed }
            ].filter(m => m.amount > 0);

            const insufficientMaterials = [];
            for (const material of rawMaterialsNeeded) {
                const inventoryId = `${currentOfficer.id}_${material.type}_${location}`;
                const inventoryDoc = await db.collection('officerInventory').doc(inventoryId).get();
                const available = inventoryDoc.exists ? inventoryDoc.data().quantity : 0;
                
                if (available < material.amount) {
                    insufficientMaterials.push(`${material.type}: need ${formatNumber(material.amount)}, have ${formatNumber(available)}`);
                }
            }

            if (insufficientMaterials.length > 0) {
                const locationData = allLocations.find(l => l.code === location);
                const locationName = locationData ? locationData.name : location;
                alert(`Insufficient materials at ${locationName}:\n${insufficientMaterials.join('\n')}`);
                return;
            }

            const craftedDisplay = craftedMaterial.charAt(0).toUpperCase() + craftedMaterial.slice(1);
            const locationData = allLocations.find(l => l.code === location);
            const locationName = locationData ? locationData.name : location;
            const officerName = currentOfficer.squadron 
                ? `[${currentOfficer.squadron}] ${currentOfficer.gamertag}`
                : currentOfficer.gamertag || 'Unknown';

            const consumedParts = [];
            if (woodUsed > 0) consumedParts.push(`${formatNumber(woodUsed)} Wood`);
            if (ironUsed > 0) consumedParts.push(`${formatNumber(ironUsed)} Iron`);
            if (coalUsed > 0) consumedParts.push(`${formatNumber(coalUsed)} Coal`);
            if (resinUsed > 0) consumedParts.push(`${formatNumber(resinUsed)} Resin`);
            if (fabricUsed > 0) consumedParts.push(`${formatNumber(fabricUsed)} Fabric`);
            const consumedString = consumedParts.join(', ');

            try {
                const batch = db.batch();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                const rawMaterials = [
                    { name: 'Wood', type: 'wood', amount: woodUsed },
                    { name: 'Iron', type: 'iron', amount: ironUsed },
                    { name: 'Coal', type: 'coal', amount: coalUsed },
                    { name: 'Resin', type: 'resin', amount: resinUsed },
                    { name: 'Fabric', type: 'fabric', amount: fabricUsed }
                ];

                for (const material of rawMaterials) {
                    if (material.amount > 0) {
                        const inventoryId = `${currentOfficer.id}_${material.type}_${location}`;
                        const inventoryRef = db.collection('officerInventory').doc(inventoryId);
                        batch.update(inventoryRef, {
                            quantity: firebase.firestore.FieldValue.increment(-material.amount),
                            lastUpdated: timestamp
                        });

                        const resourceQuery = await db.collection('guildResources')
                            .where('materialType', '==', material.name)
                            .get();
                        
                        if (!resourceQuery.empty) {
                            batch.update(resourceQuery.docs[0].ref, {
                                currentStock: firebase.firestore.FieldValue.increment(-material.amount),
                                lastUpdated: timestamp,
                                updatedBy: currentOfficer.id
                            });
                        }
                    }
                }

                const craftedInventoryId = `${currentOfficer.id}_${craftedMaterial}_${location}`;
                const craftedInventoryRef = db.collection('officerInventory').doc(craftedInventoryId);
                const existingCraftedInventory = await craftedInventoryRef.get();
                
                if (existingCraftedInventory.exists) {
                    batch.update(craftedInventoryRef, {
                        quantity: firebase.firestore.FieldValue.increment(craftedQuantity),
                        lastUpdated: timestamp
                    });
                } else {
                    batch.set(craftedInventoryRef, {
                        officerId: currentOfficer.id,
                        resourceType: craftedMaterial,
                        location: location,
                        quantity: craftedQuantity,
                        lastUpdated: timestamp
                    });
                }

                const craftedResourceQuery = await db.collection('guildResources')
                    .where('materialType', '==', craftedDisplay)
                    .get();
                
                if (!craftedResourceQuery.empty) {
                    batch.update(craftedResourceQuery.docs[0].ref, {
                        currentStock: firebase.firestore.FieldValue.increment(craftedQuantity),
                        lastUpdated: timestamp,
                        updatedBy: currentOfficer.id
                    });
                }

                const ledgerRef = db.collection('admiralLedger').doc();
                batch.set(ledgerRef, {
                    action: 'Crafting Logged',
                    details: `${officerName} crafted ${formatNumber(craftedQuantity)} ${craftedDisplay} at ${locationName} using ${consumedString}`,
                    performedBy: currentOfficer.id,
                    performedByName: officerName,
                    timestamp: timestamp
                });

                await batch.commit();

                alert(`Crafting logged!\n${formatNumber(craftedQuantity)} ${craftedDisplay} added at ${locationName}\n\nConsumed: ${consumedString}`);

                document.getElementById('craftingLocation').value = '';
                document.getElementById('craftedMaterial').value = '';
                document.getElementById('craftedQuantity').value = '';
                document.getElementById('craftWood').value = '';
                document.getElementById('craftIron').value = '';
                document.getElementById('craftCoal').value = '';
                document.getElementById('craftResin').value = '';
                document.getElementById('craftFabric').value = '';

            } catch (err) {
                console.error('Error logging crafting:', err);
                alert('Error: ' + err.message);
            }
        }

        async function toggleMemberDetails(playerId, button) {
            const existingRow = document.getElementById(`details-${playerId}`);
            
            if (existingRow) {
                existingRow.remove();
                button.textContent = 'Expand';
                return;
            }
            
            button.textContent = 'Loading...';
            
            const parentRow = button.closest('tr');
            const detailsRow = document.createElement('tr');
            detailsRow.id = `details-${playerId}`;
            detailsRow.className = 'details-row';
            detailsRow.innerHTML = `
                <td colspan="8">
                    <div class="details-content">
                        <div class="details-section">
                            <h4>üì• Contributions Made</h4>
                            <div class="details-list" id="contributions-${playerId}">
                                <div class="no-records">Loading...</div>
                            </div>
                        </div>
                        <div class="details-section">
                            <h4>üì§ Resources Received</h4>
                            <div class="details-list" id="distributions-${playerId}">
                                <div class="no-records">Loading...</div>
                            </div>
                        </div>
                    </div>
                </td>
            `;
            
            parentRow.after(detailsRow);
            button.textContent = 'Collapse';
            
            try {
                const contributions = await db.collection('contributions')
                    .where('playerId', '==', playerId)
                    .orderBy('createdAt', 'desc')
                    .limit(15)
                    .get();
                
                const contContainer = document.getElementById(`contributions-${playerId}`);
                if (contributions.empty) {
                    contContainer.innerHTML = '<div class="no-records">No contributions recorded</div>';
                } else {
                    contContainer.innerHTML = contributions.docs.map(doc => {
                        const c = doc.data();
                        const date = c.createdAt ? c.createdAt.toDate().toLocaleDateString() : 'Unknown';
                        return `
                            <div class="details-item">
                                <div class="details-item-type">${c.activityType}</div>
                                <div class="details-item-meta">
                                    ${c.materialType ? formatNumber(c.materialQuantity) + ' ' + c.materialType + ' ‚Ä¢ ' : ''}
                                    +${c.pointsEarned} HC ‚Ä¢ ${date}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error('Error loading contributions:', err);
                document.getElementById(`contributions-${playerId}`).innerHTML = 
                    '<div class="no-records">Error loading contributions</div>';
            }
            
            try {
                const distributions = await db.collection('distributions')
                    .where('playerId', '==', playerId)
                    .orderBy('timestamp', 'desc')
                    .limit(15)
                    .get();
                
                const distContainer = document.getElementById(`distributions-${playerId}`);
                if (distributions.empty) {
                    distContainer.innerHTML = '<div class="no-records">No distributions recorded</div>';
                } else {
                    distContainer.innerHTML = distributions.docs.map(doc => {
                        const d = doc.data();
                        const date = d.timestamp ? d.timestamp.toDate().toLocaleDateString() : 'Unknown';
                        const resource = d.resourceType.charAt(0).toUpperCase() + d.resourceType.slice(1);
                        return `
                            <div class="details-item">
                                <div class="details-item-type distribution">${formatNumber(d.quantity)} ${resource}</div>
                                <div class="details-item-meta">
                                    ${d.notes ? d.notes + ' ‚Ä¢ ' : ''}${date}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error('Error loading distributions:', err);
                document.getElementById(`distributions-${playerId}`).innerHTML = 
                    '<div class="no-records">Error loading distributions</div>';
            }
        }

        async function promoteToAdmiral() {
            const playerId = document.getElementById('admiralPlayer').value;
            if (!playerId) { alert('Select a player'); return; }

            const playerDoc = allMembers.find(m => m.id === playerId);
            const playerData = playerDoc ? playerDoc.data() : {};
            
            if (playerData.isAdmiral) { alert('This player is already an admiral'); return; }

            const playerName = playerData.gamertag || 'Unknown';

            if (!confirm(`Promote ${playerName} to Admiral?`)) return;

            try {
                await db.collection('players').doc(playerId).update({ isAdmiral: true });
                await logToLedger('Admiral Promoted', `${playerName} was promoted to Admiral`);
                alert(`${playerName} is now an Admiral!`);
                document.getElementById('admiralPlayer').value = '';
            } catch (err) {
                console.error('Error promoting admiral:', err);
                alert('Error: ' + err.message);
            }
        }

        async function demoteAdmiral() {
            const playerId = document.getElementById('admiralPlayer').value;
            if (!playerId) { alert('Select a player'); return; }

            const playerDoc = allMembers.find(m => m.id === playerId);
            const playerData = playerDoc ? playerDoc.data() : {};
            
            if (!playerData.isAdmiral) { alert('This player is not an admiral'); return; }

            const playerName = playerData.gamertag || 'Unknown';

            if (!confirm(`Remove Admiral status from ${playerName}?`)) return;

            try {
                await db.collection('players').doc(playerId).update({ isAdmiral: false });
                await logToLedger('Admiral Demoted', `${playerName} was removed as Admiral`);
                alert(`${playerName} is no longer an Admiral`);
                document.getElementById('admiralPlayer').value = '';
            } catch (err) {
                console.error('Error demoting admiral:', err);
                alert('Error: ' + err.message);
            }
        }

        async function changePlayerGuild() {
            const playerId = document.getElementById('guildChangePlayer').value;
            const newGuild = document.getElementById('newGuildSelect').value;
            
            if (!playerId) { alert('Select a player'); return; }
            if (!newGuild) { alert('Select a guild'); return; }

            const playerDoc = allMembers.find(m => m.id === playerId);
            const playerData = playerDoc ? playerDoc.data() : {};
            const playerName = playerData.gamertag || 'Unknown';
            const oldGuild = playerData.squadron || 'None';
            
            const guildData = allGuilds.find(g => g.code === newGuild);
            const newGuildName = guildData ? guildData.name : newGuild;

            if (oldGuild === newGuild) { alert('Player is already in this guild'); return; }

            if (!confirm(`Move ${playerName} from ${oldGuild} to ${newGuildName}?`)) return;

            try {
                await db.collection('players').doc(playerId).update({ squadron: newGuild });
                await logToLedger('Guild Change', `${playerName} moved from ${oldGuild} to ${newGuildName}`);
                alert(`${playerName} is now in ${newGuildName}`);
                document.getElementById('guildChangePlayer').value = '';
                document.getElementById('newGuildSelect').value = '';
            } catch (err) {
                console.error('Error changing guild:', err);
                alert('Error: ' + err.message);
            }
        }

        function displayGuildAlliances() {
            const container = document.getElementById('guildAllianceList');
            
            if (allGuilds.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #5c4a3a;">No guilds found</div>';
                return;
            }
            
            const memberCounts = {};
            allMembers.forEach(doc => {
                const squadron = doc.data().squadron;
                if (squadron) {
                    memberCounts[squadron] = (memberCounts[squadron] || 0) + 1;
                }
            });
            
            container.innerHTML = allGuilds.map(guild => {
                const memberCount = memberCounts[guild.code] || 0;
                const isPartner = guild.isAlly === true;
                const badge = isPartner 
                    ? '<span class="partner-badge">TRADE PARTNER</span>' 
                    : '<span class="non-partner-badge">NOT PARTNER</span>';
                const buttonText = isPartner ? 'Remove Partner' : 'Add as Partner';
                const buttonClass = isPartner ? 'btn-danger' : 'btn-success';
                
                return `
                    <div class="guild-alliance-item">
                        <div class="guild-alliance-info">
                            <img src="${guild.logo || 'default_guild.png'}" alt="${guild.name}" class="guild-alliance-logo">
                            <div>
                                <div class="guild-alliance-name">${guild.name}${badge}</div>
                                <div class="guild-alliance-meta">${memberCount} member${memberCount !== 1 ? 's' : ''}</div>
                            </div>
                        </div>
                        <button class="btn btn-small ${buttonClass}" onclick="toggleGuildAlliance('${guild.code}', ${isPartner})">
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function toggleGuildAlliance(guildCode, currentlyPartner) {
            const guild = allGuilds.find(g => g.code === guildCode);
            const guildName = guild ? guild.name : guildCode;
            const newStatus = !currentlyPartner;
            
            const action = newStatus ? 'add as trade partner' : 'remove trade partner status from';
            if (!confirm(`Are you sure you want to ${action} ${guildName}?`)) return;
            
            try {
                await db.collection('guilds').doc(guildCode).update({ isAlly: newStatus });
                
                const guildIndex = allGuilds.findIndex(g => g.code === guildCode);
                if (guildIndex >= 0) {
                    allGuilds[guildIndex].isAlly = newStatus;
                }
                
                await logToLedger(
                    newStatus ? 'Trade Partner Added' : 'Trade Partner Removed',
                    `${guildName} ${newStatus ? 'added as trade partner' : 'removed as trade partner'}`
                );
                
                displayGuildAlliances();
                alert(`${guildName} is now ${newStatus ? 'a trade partner' : 'no longer a trade partner'}`);
                
            } catch (err) {
                console.error('Error updating guild partnership:', err);
                alert('Error: ' + err.message);
            }
        }

        async function initializeInventory() {
            const officerId = document.getElementById('initInventoryOfficer').value;
            const resourceType = document.getElementById('initInventoryResource').value;
            const quantity = parseInt(document.getElementById('initInventoryQuantity').value);
            const location = document.getElementById('initInventoryLocation').value;
            const note = document.getElementById('initInventoryNote').value.trim();

            if (!officerId) { alert('Select an officer'); return; }
            if (!resourceType) { alert('Select a resource type'); return; }
            if (!quantity || quantity < 1) { alert('Enter a valid quantity'); return; }
            if (!location) { alert('Select a storage location'); return; }
            if (!note) { alert('Note is required'); return; }

            const officerDoc = allMembers.find(m => m.id === officerId);
            const officerData = officerDoc ? officerDoc.data() : {};
            const officerName = officerData.gamertag || 'Unknown';
            const officerSquadron = officerData.squadron ? `[${officerData.squadron}] ` : '';
            
            const locationData = allLocations.find(l => l.code === location);
            const locationName = locationData ? locationData.name : location;
            
            const resourceDisplay = resourceType.charAt(0).toUpperCase() + resourceType.slice(1);

            if (!confirm(`Initialize inventory:\n${formatNumber(quantity)} ${resourceDisplay}\nHeld by: ${officerSquadron}${officerName}\nLocation: ${locationName}\n\nThis does not affect Holding Coins. Continue?`)) {
                return;
            }

            try {
                const batch = db.batch();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                const inventoryId = `${officerId}_${resourceType}_${location}`;
                const inventoryRef = db.collection('officerInventory').doc(inventoryId);
                const existingInventory = await inventoryRef.get();
                
                if (existingInventory.exists) {
                    batch.update(inventoryRef, {
                        quantity: firebase.firestore.FieldValue.increment(quantity),
                        lastUpdated: timestamp
                    });
                } else {
                    batch.set(inventoryRef, {
                        officerId: officerId,
                        resourceType: resourceType,
                        location: location,
                        quantity: quantity,
                        lastUpdated: timestamp
                    });
                }

                const resourceQuery = await db.collection('guildResources')
                    .where('materialType', '==', resourceDisplay)
                    .get();
                
                if (!resourceQuery.empty) {
                    batch.update(resourceQuery.docs[0].ref, {
                        currentStock: firebase.firestore.FieldValue.increment(quantity),
                        lastUpdated: timestamp,
                        updatedBy: currentOfficer.id
                    });
                }

                await batch.commit();

                await logToLedger(
                    'Inventory Initialized',
                    `${formatNumber(quantity)} ${resourceDisplay} assigned to ${officerSquadron}${officerName} at ${locationName}`,
                    note
                );

                alert(`Inventory initialized!\n${formatNumber(quantity)} ${resourceDisplay}\nAssigned to ${officerName} at ${locationName}`);

                document.getElementById('initInventoryOfficer').value = '';
                document.getElementById('initInventoryResource').value = '';
                document.getElementById('initInventoryQuantity').value = '';
                document.getElementById('initInventoryLocation').value = '';
                document.getElementById('initInventoryNote').value = '';

            } catch (err) {
                console.error('Error initializing inventory:', err);
                alert('Error: ' + err.message);
            }
        }

        async function displayResourcesWithOfficers(inventoryDocs) {
            const container = document.getElementById('resourcesDisplay');
            
            if (inventoryDocs.length === 0) {
                container.innerHTML = '<div class="resource-no-data">No inventory records. Use "Initialize Inventory" to add existing holdings.</div>';
                return;
            }
            
            const resourceMap = {};
            
            inventoryDocs.forEach(doc => {
                const inv = doc.data();
                if (inv.quantity <= 0) return;
                
                const resource = inv.resourceType;
                const location = inv.location;
                const officerId = inv.officerId;
                
                if (!resourceMap[resource]) {
                    resourceMap[resource] = { total: 0, locations: {} };
                }
                
                if (!resourceMap[resource].locations[location]) {
                    resourceMap[resource].locations[location] = { total: 0, officers: {} };
                }
                
                resourceMap[resource].total += inv.quantity;
                resourceMap[resource].locations[location].total += inv.quantity;
                
                if (!resourceMap[resource].locations[location].officers[officerId]) {
                    resourceMap[resource].locations[location].officers[officerId] = 0;
                }
                resourceMap[resource].locations[location].officers[officerId] += inv.quantity;
            });
            
            const officerNames = {};
            allMembers.forEach(doc => {
                const data = doc.data();
                const prefix = data.squadron ? `[${data.squadron}] ` : '';
                officerNames[doc.id] = prefix + (data.gamertag || 'Unknown');
            });
            
            const locationNames = {};
            allLocations.forEach(loc => {
                locationNames[loc.code] = loc.name;
            });
            
            const sortedResources = Object.keys(resourceMap).sort();
            
            if (sortedResources.length === 0) {
                container.innerHTML = '<div class="resource-no-data">No inventory records. Use "Initialize Inventory" to add existing holdings.</div>';
                return;
            }
            
            let html = '';
            
            sortedResources.forEach(resource => {
                const resourceData = resourceMap[resource];
                const resourceDisplay = resource.charAt(0).toUpperCase() + resource.slice(1);
                
                html += `
                    <div class="resource-group">
                        <div class="resource-group-header">
                            <span class="resource-group-name">${resourceDisplay}</span>
                            <span class="resource-group-total">${formatNumber(resourceData.total)} total</span>
                        </div>
                `;
                
                const sortedLocations = Object.keys(resourceData.locations).sort((a, b) => {
                    const nameA = locationNames[a] || a;
                    const nameB = locationNames[b] || b;
                    return nameA.localeCompare(nameB);
                });
                
                sortedLocations.forEach(location => {
                    const locationData = resourceData.locations[location];
                    const locationDisplay = locationNames[location] || location;
                    
                    html += `
                        <div class="resource-location">
                            <div class="resource-location-header">${locationDisplay} (${formatNumber(locationData.total)})</div>
                            <div class="resource-officer-list">
                    `;
                    
                    const sortedOfficers = Object.entries(locationData.officers)
                        .sort((a, b) => b[1] - a[1]);
                    
                    sortedOfficers.forEach(([officerId, quantity]) => {
                        const officerName = officerNames[officerId] || 'Unknown';
                        html += `
                            <div class="resource-officer-item">
                                <span class="resource-officer-name">${officerName}:</span> ${formatNumber(quantity)}
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        async function updateDistributionSources() {
            const resourceType = document.getElementById('distributionResource').value;
            const location = document.getElementById('distributionLocation').value;
            const fromOfficerSelect = document.getElementById('distributionFromOfficer');
            
            fromOfficerSelect.innerHTML = '<option value="">-- Select resource and location first --</option>';
            
            if (!resourceType || !location) { return; }
            
            try {
                const inventorySnapshot = await db.collection('officerInventory')
                    .where('resourceType', '==', resourceType)
                    .where('location', '==', location)
                    .get();
                
                const sources = [];
                
                inventorySnapshot.docs.forEach(doc => {
                    const inv = doc.data();
                    if (inv.quantity > 0) {
                        sources.push({
                            officerId: inv.officerId,
                            quantity: inv.quantity,
                            docId: doc.id
                        });
                    }
                });
                
                if (sources.length === 0) {
                    const locationData = allLocations.find(l => l.code === location);
                    const locationName = locationData ? locationData.name : location;
                    fromOfficerSelect.innerHTML = `<option value="">No ${resourceType} at ${locationName}</option>`;
                    return;
                }
                
                fromOfficerSelect.innerHTML = '<option value="">-- Select source --</option>';
                
                sources.forEach(source => {
                    const memberDoc = allMembers.find(m => m.id === source.officerId);
                    const memberData = memberDoc ? memberDoc.data() : {};
                    const prefix = memberData.squadron ? `[${memberData.squadron}] ` : '';
                    const name = memberData.gamertag || 'Unknown';
                    const isOfficer = memberData.isOfficer ? '' : ' (former officer)';
                    
                    const option = document.createElement('option');
                    option.value = source.officerId;
                    option.textContent = `${prefix}${name}${isOfficer} - ${formatNumber(source.quantity)} available`;
                    option.dataset.available = source.quantity;
                    fromOfficerSelect.appendChild(option);
                });
                
            } catch (err) {
                console.error('Error loading distribution sources:', err);
                fromOfficerSelect.innerHTML = '<option value="">Error loading sources</option>';
            }
        }
    </script>
</body>
</html>
