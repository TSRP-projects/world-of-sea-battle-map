<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WOSB Guild Tracker</title>
    <link rel="icon" type="image/png" href="Blackwolf Holdings Medallion.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Libre Baskerville', Georgia, serif;
            background: url('wosb-app-background.png') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            color: #3d2b1f;
            padding: 20px;
        }
        
        .header {
            background: rgba(244, 236, 217, 0.95);
            border: 2px solid #8b6914;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .squadron-badge {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 50%;
            border: 2px solid #8b6914;
        }
        
        .user-info h2 { 
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914; 
            font-size: 20px; 
        }
        .user-info p { color: #5c4a3a; font-size: 14px; }
        .user-info .gamertag { color: #8b6914; font-weight: bold; }
        
        .btn {
            padding: 10px 20px;
            border: 2px solid #8b6914;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Libre Baskerville', Georgia, serif;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn-primary { 
            background: #8b6914; 
            color: #f5f0e6; 
        }
        .btn-primary:hover { 
            background: #6d5310; 
        }
        .btn-secondary { 
            background: rgba(244, 236, 217, 0.9); 
            color: #3d2b1f; 
        }
        .btn-secondary:hover { 
            background: #8b6914;
            color: #f5f0e6;
        }
        .btn-danger { 
            background: #8b3a3a; 
            color: #f5f0e6; 
            border-color: #722;
        }
        .btn-danger:hover { 
            background: #6b2a2a; 
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: rgba(244, 236, 217, 0.9);
            border: 2px solid #8b6914;
            border-radius: 5px;
            color: #3d2b1f;
            text-decoration: none;
            font-family: 'Cinzel', Georgia, serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover { 
            background: #8b6914;
            color: #f5f0e6;
        }
        .nav-btn.active { 
            background: #8b6914; 
            color: #f5f0e6; 
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(244, 236, 217, 0.95);
            border: 2px solid #8b6914;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .card-wide {
            grid-column: 1 / -1;
            margin-bottom: 10px;
        }
        
        .card h3 {
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914;
            margin-bottom: 15px;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(139, 105, 20, 0.3);
        }
        
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: #5c4a3a; }
        .stat-value { color: #8b6914; font-weight: bold; }
        
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #8b6914;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .gamertag-input {
            padding: 5px 10px;
            background: #f5f0e6;
            border: 1px solid #8b6914;
            border-radius: 3px;
            font-family: 'Libre Baskerville', Georgia, serif;
            font-size: 12px;
            color: #3d2b1f;
            width: 150px;
        }
        
        .gamertag-display {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-gamertag {
            cursor: pointer;
            color: #8b6914;
            font-size: 12px;
        }

        .leaderboard { margin-top: 10px; }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            background: rgba(139, 105, 20, 0.1);
            border: 1px solid rgba(139, 105, 20, 0.2);
            border-radius: 5px;
            margin-bottom: 6px;
        }
        
        .leaderboard-rank { 
            font-family: 'Cinzel', Georgia, serif;
            font-weight: bold; 
            color: #8b6914; 
            margin-right: 10px; 
        }
        .leaderboard-name { flex: 1; color: #3d2b1f; }
        .leaderboard-value { color: #8b6914; font-weight: bold; }
        
        .rank-1 .leaderboard-rank { color: #c9a227; font-size: 16px; }
        .rank-2 .leaderboard-rank { color: #888; }
        .rank-3 .leaderboard-rank { color: #8b5a2b; }
        
        .leaderboard-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .leaderboard-column h4 {
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .ledger-container {
            max-height: 250px;
            overflow-y: auto;
        }

        .ledger-entry {
            padding: 10px;
            border-bottom: 1px solid rgba(139, 105, 20, 0.2);
        }

        .ledger-entry:last-child {
            border-bottom: none;
        }

        .ledger-entry:hover {
            background: rgba(139, 105, 20, 0.05);
        }

        .ledger-action {
            font-weight: bold;
            color: #8b6914;
            font-family: 'Cinzel', Georgia, serif;
            font-size: 13px;
        }

        .ledger-action.action-add { color: #2d5a2d; }
        .ledger-action.action-remove { color: #8b3a3a; }
        .ledger-action.action-officer { color: #8b6914; }

        .ledger-details {
            font-size: 12px;
            color: #3d2b1f;
            margin-top: 4px;
        }

        .ledger-justification {
            font-style: italic;
            color: #5c4a3a;
            font-size: 11px;
            margin-top: 4px;
            padding-left: 8px;
            border-left: 2px solid #8b6914;
        }

        .ledger-meta {
            font-size: 10px;
            color: #5c4a3a;
            margin-top: 4px;
        }

        .donation-breakdown {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(139, 105, 20, 0.3);
        }

        .donation-header {
            font-family: 'Cinzel', Georgia, serif;
            font-size: 14px;
            color: #8b6914;
            margin-bottom: 10px;
        }

        .donation-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .donation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: rgba(139, 105, 20, 0.1);
            border: 1px solid rgba(139, 105, 20, 0.2);
            border-radius: 4px;
            font-size: 13px;
        }

        .donation-material {
            color: #3d2b1f;
        }

        .donation-amount {
            color: #8b6914;
            font-weight: bold;
        }

        .donation-empty {
            grid-column: 1 / -1;
            text-align: center;
            color: #5c4a3a;
            font-size: 13px;
            padding: 10px;
        }

        .admiral-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(139, 105, 20, 0.1);
            border: 1px solid rgba(139, 105, 20, 0.2);
            border-radius: 5px;
            margin-bottom: 8px;
        }

        .admiral-list-item:last-child {
            margin-bottom: 0;
        }

        .admiral-icon {
            font-size: 20px;
        }

        .admiral-name {
            font-weight: bold;
            color: #8b6914;
        }

        .admiral-empty {
            text-align: center;
            color: #5c4a3a;
            padding: 15px;
            font-style: italic;
        }

        .partner-indicator {
            background: linear-gradient(135deg, #2d5a2d, #3d7a3d);
            color: #f5f0e6;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-family: 'Cinzel', Georgia, serif;
            margin-left: 12px;
            border: 1px solid #4a8a4a;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .resource-group {
            background: rgba(139, 105, 20, 0.1);
            border: 1px solid rgba(139, 105, 20, 0.3);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .resource-group:last-child {
            margin-bottom: 0;
        }

        .resource-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(139, 105, 20, 0.3);
        }

        .resource-group-name {
            font-family: 'Cinzel', Georgia, serif;
            color: #8b6914;
            font-size: 16px;
            font-weight: bold;
        }

        .resource-group-total {
            font-size: 18px;
            font-weight: bold;
            color: #2d5a2d;
        }

        .resource-location {
            margin-left: 10px;
            padding: 8px 12px;
            background: rgba(139, 105, 20, 0.05);
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .resource-location:last-child {
            margin-bottom: 0;
        }

        .resource-location-header {
            font-weight: bold;
            color: #5c4a3a;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .resource-officer-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-left: 10px;
        }

        .resource-officer-item {
            background: rgba(139, 105, 20, 0.15);
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 12px;
            color: #3d2b1f;
        }

        .resource-officer-name {
            color: #8b6914;
            font-weight: bold;
        }

        .resource-no-data {
            color: #5c4a3a;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .hc-balance {
            font-size: 28px;
            font-weight: bold;
            color: #8b6914;
            text-align: center;
            padding: 15px;
            background: rgba(139, 105, 20, 0.1);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .hc-breakdown {
            display: flex;
            justify-content: space-around;
            text-align: center;
            padding: 10px 0;
        }

        .hc-item {
            flex: 1;
        }

        .hc-item-label {
            font-size: 12px;
            color: #5c4a3a;
        }

        .hc-item-value {
            font-size: 16px;
            font-weight: bold;
            color: #3d2b1f;
        }

        .rate-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .rate-item {
            padding: 8px;
            background: rgba(139, 105, 20, 0.1);
            border: 1px solid rgba(139, 105, 20, 0.2);
            border-radius: 4px;
            text-align: center;
        }

        .rate-resource {
            font-size: 11px;
            color: #5c4a3a;
            font-family: 'Cinzel', Georgia, serif;
        }

        .rate-value {
            font-size: 14px;
            font-weight: bold;
            color: #8b6914;
        }

        .rate-normal { color: #8b6914; }
        .rate-needed { color: #2d5a2d; }
        .rate-critical { color: #8b3a3a; }
        .rate-surplus { color: #888; }

        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(139, 105, 20, 0.1);
            border: 1px solid rgba(139, 105, 20, 0.2);
            border-radius: 5px;
            margin-bottom: 8px;
        }

        .shop-item:last-child {
            margin-bottom: 0;
        }

        .shop-item-info {
            flex: 1;
        }

        .shop-item-name {
            font-weight: bold;
            color: #3d2b1f;
        }

        .shop-item-price {
            font-size: 12px;
            color: #8b6914;
        }

        .shop-item-stock {
            font-size: 11px;
            color: #5c4a3a;
        }

        .shop-placeholder {
            text-align: center;
            padding: 30px;
            color: #5c4a3a;
            font-style: italic;
        }
        
        .bottom-cards {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            width: 100%;
            margin-top: 20px;
        }
        
        @media (max-width: 1200px) {
            .bottom-cards {
                grid-template-columns: 1fr 1fr;
            }
            .leaderboard-columns {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .bottom-cards {
                grid-template-columns: 1fr;
            }
            .rate-display {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <img id="squadronBadge" class="squadron-badge" src="" alt="Squadron" title="" style="display: none;">
            <div class="user-info">
                <div id="gamertag-container">
                    <span id="gamertag-display">Loading...</span>
                    <span id="partnerIndicator" class="partner-indicator" style="display: none;">Trade Partner</span>
                    <span id="edit-gamertag" class="edit-gamertag" onclick="showGametagInput()" title="Edit gamertag">‚úèÔ∏è</span>
                    <span id="gamertag-edit" style="display: none;">
                        <input type="text" id="gamertag-input" class="gamertag-input" placeholder="Enter gamertag" maxlength="30">
                        <button class="btn btn-small btn-primary" onclick="saveGamertag()">Save</button>
                    </span>
                </div>
                <p id="userGuild">Loading guild...</p>
            </div>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="location.href='index.html'">Back to Map</button>
            <button class="btn btn-danger" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="navigation">
        <a href="dashboard.html" class="nav-btn active">Dashboard</a>
        <a href="history.html" class="nav-btn">My History</a>
        <a href="admin.html" class="nav-btn" id="adminNav" style="display: none;">Officer Panel</a>
        <a href="guild-panel.html" class="nav-btn" id="guildNav" style="display: none;">Guild Panel</a>
        <a href="ships.html" class="nav-btn" id="shipsLink" style="display: none;">Ship Database</a>
    </div>

    <div id="loading" class="loading">Loading your data...</div>

    <div id="dashboard" style="display: none;">
        <div class="dashboard-grid">
            <div class="card">
                <h3>üí∞ Holding Coins</h3>
                <div class="hc-balance" id="hcBalance">0 HC</div>
                <div class="hc-breakdown">
                    <div class="hc-item">
                        <div class="hc-item-label">Total Earned</div>
                        <div class="hc-item-value" id="hcEarned">0</div>
                    </div>
                    <div class="hc-item">
                        <div class="hc-item-label">Spent</div>
                        <div class="hc-item-value" id="hcSpent">0</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üìà Exchange Rates</h3>
                <p style="color: #5c4a3a; font-size: 12px; margin-bottom: 10px;">
                    Current HC rates for donations. Higher = guild needs more.
                </p>
                <div class="rate-display" id="rateDisplay">
                    <div style="text-align: center; color: #5c4a3a;">Loading...</div>
                </div>
            </div>

            <div class="card">
                <h3>‚öì Guild Admirals</h3>
                <div id="guildAdmiralsList">
                    <div style="text-align: center; color: #5c4a3a;">Loading...</div>
                </div>
            </div>

            <div class="card">
                <h3>üìú Admiral's Ledger</h3>
                <div class="ledger-container" id="ledgerContainer">
                    <div style="text-align: center; color: #5c4a3a;">Loading...</div>
                </div>
            </div>

            <div class="card">
                <h3>üìä Activity Status</h3>
                <div class="stat-row">
                    <span class="stat-label">Forts Destroyed:</span>
                    <span class="stat-value" id="fortsCount">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Last Activity:</span>
                    <span class="stat-value" id="lastActivity">Never</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Status:</span>
                    <span class="stat-value" id="activityStatus">Unknown</span>
                </div>
                <div class="donation-breakdown">
                    <div class="donation-header">My Donations (All-Time)</div>
                    <div id="donationBreakdown" class="donation-grid">
                        <div class="donation-empty">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üõí Guild Shop</h3>
                <p style="color: #5c4a3a; font-size: 12px; margin-bottom: 10px;">
                    Spend your Holding Coins on materials from guild storage.
                </p>
                <div id="shopContainer" class="shop-placeholder">
                    Shop system coming soon. Use your HC to purchase materials from guild inventory.
                </div>
            </div>
        </div>

        <div class="bottom-cards">
            <div class="card">
                <h3>üèÜ Leaderboards</h3>
                <div class="leaderboard-columns">
                    <div class="leaderboard-column">
                        <h4>‚öîÔ∏è Fort Busting</h4>
                        <div class="leaderboard" id="fortLeaderboard">
                            <div style="text-align: center; color: #5c4a3a;">Loading...</div>
                        </div>
                    </div>
                    <div class="leaderboard-column">
                        <h4>üíé Donations</h4>
                        <div class="leaderboard" id="resourceLeaderboard">
                            <div style="text-align: center; color: #5c4a3a;">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üè¶ Guild Resources</h3>
                <div id="resourcesDisplay"></div>
            </div>

            <div class="card">
                <h3>üìã Recent Activity</h3>
                <div id="recentActivityContainer">
                    <div style="text-align: center; color: #5c4a3a;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        let currentPlayer = null;
        let allLocations = [];
        let allMembers = [];
        let exchangeRates = {};

        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                loadDashboard(user.uid);
            }
        });

        async function loadDashboard(userId) {
            try {
                // Load locations
                const locationsSnapshot = await db.collection('locations').where('isActive', '==', true).get();
                allLocations = locationsSnapshot.docs.map(doc => ({ code: doc.id, ...doc.data() }));
                allLocations.sort((a, b) => a.name.localeCompare(b.name));

                // Load members (for officer names in resource display)
                db.collection('players')
                    .orderBy('totalPoints', 'desc')
                    .onSnapshot(snapshot => {
                        allMembers = snapshot.docs;
                    });

                // Load exchange rates
                db.collection('guildResources').onSnapshot(snapshot => {
                    exchangeRates = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const key = data.materialType.toLowerCase();
                        exchangeRates[key] = {
                            base: data.baseHCValue || POINT_VALUES[key.toUpperCase()] || 1,
                            current: data.currentHCValue || data.baseHCValue || POINT_VALUES[key.toUpperCase()] || 1,
                            multiplier: data.rateMultiplier || 1.0
                        };
                    });
                    displayExchangeRates();
                });

                // Set up player listener
                db.collection('players').doc(userId).onSnapshot(async doc => {
                    if (doc.exists) {
                        currentPlayer = { id: doc.id, ...doc.data() };
                        
                        // Load guild partnership status
                        let isPartner = false;
                        if (currentPlayer.squadron && currentPlayer.squadron !== 'BWH') {
                            try {
                                const guildDoc = await db.collection('guilds').doc(currentPlayer.squadron).get();
                                if (guildDoc.exists) {
                                    isPartner = guildDoc.data().isAlly === true;
                                }
                            } catch (err) {
                                console.error('Error loading guild:', err);
                            }
                        }
                        currentPlayer.isPartner = isPartner;
                        
                        updatePlayerUI(currentPlayer);
                    }
                });

                // Listen to officerInventory for detailed resource display
                db.collection('officerInventory').onSnapshot(snapshot => {
                    displayResourcesWithOfficers(snapshot.docs);
                });

                // Real-time listener for Admiral's Ledger
                db.collection('admiralLedger')
                    .orderBy('timestamp', 'desc')
                    .limit(15)
                    .onSnapshot(snapshot => {
                        displayLedger(snapshot.docs);
                    });

                // Load recent activity for current user
                loadRecentActivity(userId);

                loadLeaderboards();
                loadDonationBreakdown(userId);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

            } catch (err) {
                console.error('Error loading dashboard:', err);
                alert('Error loading dashboard: ' + err.message);
            }
        }

        function updatePlayerUI(player) {
            // Load guild admirals
            loadGuildAdmirals(player.squadron);

            // Display gamertag
            const gamertagDisplay = document.getElementById('gamertag-display');
            if (player.gamertag) {
                const prefix = player.squadron ? `[${player.squadron}] ` : '';
                gamertagDisplay.textContent = prefix + player.gamertag;
            } else {
                gamertagDisplay.textContent = 'Set gamertag';
                gamertagDisplay.style.fontStyle = 'italic';
                gamertagDisplay.style.color = '#999';
            }

            // Display partner indicator
            const partnerIndicator = document.getElementById('partnerIndicator');
            if (player.isPartner) {
                partnerIndicator.style.display = 'inline-block';
            } else {
                partnerIndicator.style.display = 'none';
            }

            // Display guild info
            const guildNames = {
                'BWC': 'Blackwolf Chapter',
                'BWH': 'Blackwolf Holdings'
            };
            document.getElementById('userGuild').textContent = guildNames[player.squadron] || player.squadron || 'No Guild';

            // Display squadron badge
            const squadronBadge = document.getElementById('squadronBadge');
            if (player.squadron) {
                const squadronLogos = {
                    'BWC': 'Blackwolf Chapter Medallion.png',
                    'BWH': 'Blackwolf Holdings Medallion.png'
                };
                if (squadronLogos[player.squadron]) {
                    squadronBadge.src = squadronLogos[player.squadron];
                    squadronBadge.title = guildNames[player.squadron] || player.squadron;
                    squadronBadge.style.display = 'block';
                } else {
                    squadronBadge.style.display = 'none';
                }
            } else {
                squadronBadge.style.display = 'none';
            }

            // Holding Coins display
            const totalHC = player.totalPoints || 0;
            const spentHC = player.sharesRedeemed || 0;
            const balanceHC = totalHC - spentHC;

            document.getElementById('hcBalance').textContent = formatNumber(balanceHC) + ' HC';
            document.getElementById('hcEarned').textContent = formatNumber(totalHC);
            document.getElementById('hcSpent').textContent = formatNumber(spentHC);

            // Activity stats
            document.getElementById('fortsCount').textContent = player.fortsDestroyed || 0;

            if (player.lastActivity) {
                const lastActivity = player.lastActivity.toDate();
                const daysAgo = Math.floor((Date.now() - lastActivity) / (1000 * 60 * 60 * 24));
                document.getElementById('lastActivity').textContent = 
                    daysAgo === 0 ? 'Today' : `${daysAgo} days ago`;
                
                const isActive = daysAgo <= 30;
                document.getElementById('activityStatus').textContent = isActive ? 'Active ‚úì' : 'Inactive ‚úó';
                document.getElementById('activityStatus').style.color = isActive ? '#2d5a2d' : '#8b3a3a';
            }

            if (player.isOfficer) {
                document.getElementById('adminNav').style.display = 'inline-block';
                document.getElementById('shipsLink').style.display = 'inline-block';
            }

            if (player.isAdmiral) {
                document.getElementById('guildNav').style.display = 'inline-block';
            }
        }

        function displayExchangeRates() {
            const container = document.getElementById('rateDisplay');
            
            const resources = [
                { name: 'Beams', key: 'beams' },
                { name: 'Bulkheads', key: 'bulkheads' },
                { name: 'Plates', key: 'plates' },
                { name: 'Canvas', key: 'canvas' },
                { name: 'Iron', key: 'iron' },
                { name: 'Wood', key: 'wood' },
                { name: 'Coal', key: 'coal' },
                { name: 'Resin', key: 'resin' },
                { name: 'Fabric', key: 'fabric' }
            ];
            
            container.innerHTML = resources.map(r => {
                const rate = exchangeRates[r.key] || { multiplier: 1.0 };
                const multiplier = rate.multiplier || 1.0;
                let rateClass = 'rate-normal';
                
                if (multiplier >= 2.0) {
                    rateClass = 'rate-critical';
                } else if (multiplier >= 1.5) {
                    rateClass = 'rate-needed';
                } else if (multiplier <= 0.5) {
                    rateClass = 'rate-surplus';
                }
                
                return `
                    <div class="rate-item">
                        <div class="rate-resource">${r.name}</div>
                        <div class="rate-value ${rateClass}">${multiplier.toFixed(1)}x</div>
                    </div>
                `;
            }).join('');
        }

        function displayLedger(docs) {
            const container = document.getElementById('ledgerContainer');
            
            if (docs.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #5c4a3a;">No entries yet</div>';
                return;
            }

            container.innerHTML = '';

            docs.forEach(doc => {
                const entry = doc.data();
                let actionClass = 'action-add';
                if (entry.action.includes('Remove') || entry.action.includes('Demote')) {
                    actionClass = 'action-remove';
                } else if (entry.action.includes('Officer') || entry.action.includes('Promote')) {
                    actionClass = 'action-officer';
                }

                const timestamp = entry.timestamp ? entry.timestamp.toDate().toLocaleString() : 'Unknown';

                const entryDiv = document.createElement('div');
                entryDiv.className = 'ledger-entry';
                entryDiv.innerHTML = `
                    <div class="ledger-action ${actionClass}">${entry.action}</div>
                    <div class="ledger-details">${entry.details || ''}</div>
                    ${entry.justification ? `<div class="ledger-justification">"${entry.justification}"</div>` : ''}
                    <div class="ledger-meta">By ${entry.performedByName || 'Unknown'} ‚Ä¢ ${timestamp}</div>
                `;
                container.appendChild(entryDiv);
            });
        }

        async function loadRecentActivity(userId) {
            const container = document.getElementById('recentActivityContainer');
            
            try {
                const contributions = await db.collection('contributions')
                    .where('playerId', '==', userId)
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                if (contributions.empty) {
                    container.innerHTML = '<div style="text-align: center; color: #5c4a3a; padding: 20px;">No activity recorded yet</div>';
                    return;
                }
                
                container.innerHTML = '';
                contributions.docs.forEach(doc => {
                    const c = doc.data();
                    const date = c.createdAt ? c.createdAt.toDate().toLocaleDateString() : 'Unknown';
                    
                    const item = document.createElement('div');
                    item.style.cssText = 'padding: 8px; border-bottom: 1px solid rgba(139, 105, 20, 0.2); font-size: 13px;';
                    item.innerHTML = `
                        <div style="color: #8b6914; font-weight: bold;">${c.activityType}</div>
                        <div style="color: #5c4a3a; font-size: 12px;">
                            ${c.materialType ? formatNumber(c.materialQuantity) + ' ' + c.materialType + ' ‚Ä¢ ' : ''}
                            +${c.pointsEarned} HC ‚Ä¢ ${date}
                        </div>
                    `;
                    container.appendChild(item);
                });
                
            } catch (err) {
                console.error('Error loading recent activity:', err);
                container.innerHTML = '<div style="text-align: center; color: #5c4a3a;">Error loading activity</div>';
            }
        }

        function showGametagInput() {
            document.getElementById('gamertag-display').style.display = 'none';
            document.getElementById('edit-gamertag').style.display = 'none';
            document.getElementById('gamertag-edit').style.display = 'inline';
            
            const input = document.getElementById('gamertag-input');
            input.value = currentPlayer.gamertag || '';
            input.focus();
        }

        async function saveGamertag() {
            const gamertag = document.getElementById('gamertag-input').value.trim();
            
            try {
                await db.collection('players').doc(auth.currentUser.uid).update({
                    gamertag: gamertag
                });
                
                document.getElementById('gamertag-display').style.display = 'inline';
                document.getElementById('edit-gamertag').style.display = 'inline';
                document.getElementById('gamertag-edit').style.display = 'none';
            } catch (err) {
                console.error('Error saving gamertag:', err);
                alert('Error: ' + err.message);
            }
        }

        async function loadLeaderboards() {
            db.collection('players')
                .orderBy('fortsDestroyed', 'desc')
                .limit(10)
                .onSnapshot(snapshot => {
                    const fortLeaderboard = document.getElementById('fortLeaderboard');
                    if (snapshot.empty) {
                        fortLeaderboard.innerHTML = '<div style="text-align: center; color: #5c4a3a;">No fort data yet</div>';
                        return;
                    }
                    
                    fortLeaderboard.innerHTML = '';
                    let rank = 0;
                    snapshot.docs.forEach(doc => {
                        const player = doc.data();
                        if (player.fortsDestroyed > 0) {
                            rank++;
                            const displayName = player.gamertag || 'Unknown';
                            const item = document.createElement('div');
                            item.className = `leaderboard-item rank-${rank}`;
                            item.innerHTML = `
                                <span class="leaderboard-rank">#${rank}</span>
                                <span class="leaderboard-name">${displayName}</span>
                                <span class="leaderboard-value">${player.fortsDestroyed} forts</span>
                            `;
                            fortLeaderboard.appendChild(item);
                        }
                    });
                    
                    if (rank === 0) {
                        fortLeaderboard.innerHTML = '<div style="text-align: center; color: #5c4a3a;">No fort data yet</div>';
                    }
                });
            
            db.collection('contributions')
                .where('activityType', '==', 'Material Donation')
                .onSnapshot(async snapshot => {
                    const playerTotals = {};
                    snapshot.docs.forEach(doc => {
                        const contrib = doc.data();
                        if (!playerTotals[contrib.playerId]) {
                            playerTotals[contrib.playerId] = { points: 0, playerId: contrib.playerId };
                        }
                        playerTotals[contrib.playerId].points += contrib.pointsEarned;
                    });
                    
                    const sorted = Object.values(playerTotals)
                        .sort((a, b) => b.points - a.points)
                        .slice(0, 10);
                    
                    await displayResourceLeaderboard(sorted);
                });
        }

        async function displayResourceLeaderboard(sorted) {
            const resourceLeaderboard = document.getElementById('resourceLeaderboard');
            
            if (sorted.length === 0) {
                resourceLeaderboard.innerHTML = '<div style="text-align: center; color: #5c4a3a;">No donations yet</div>';
                return;
            }
            
            resourceLeaderboard.innerHTML = '';
            
            for (let i = 0; i < sorted.length; i++) {
                const entry = sorted[i];
                const playerDoc = await db.collection('players').doc(entry.playerId).get();
                const playerData = playerDoc.exists ? playerDoc.data() : {};
                const displayName = playerData.gamertag || 'Unknown';
                
                const item = document.createElement('div');
                item.className = `leaderboard-item rank-${i + 1}`;
                item.innerHTML = `
                    <span class="leaderboard-rank">#${i + 1}</span>
                    <span class="leaderboard-name">${displayName}</span>
                    <span class="leaderboard-value">${formatNumber(entry.points)} HC</span>
                `;
                resourceLeaderboard.appendChild(item);
            }
        }

        function displayResourcesWithOfficers(inventoryDocs) {
            const container = document.getElementById('resourcesDisplay');
            
            if (inventoryDocs.length === 0) {
                container.innerHTML = '<div class="resource-no-data">No guild resources tracked yet.</div>';
                return;
            }
            
            const resourceMap = {};
            
            inventoryDocs.forEach(doc => {
                const inv = doc.data();
                if (inv.quantity <= 0) return;
                
                const resource = inv.resourceType;
                const location = inv.location;
                const officerId = inv.officerId;
                
                if (!resourceMap[resource]) {
                    resourceMap[resource] = { total: 0, locations: {} };
                }
                
                if (!resourceMap[resource].locations[location]) {
                    resourceMap[resource].locations[location] = { total: 0, officers: {} };
                }
                
                resourceMap[resource].total += inv.quantity;
                resourceMap[resource].locations[location].total += inv.quantity;
                
                if (!resourceMap[resource].locations[location].officers[officerId]) {
                    resourceMap[resource].locations[location].officers[officerId] = 0;
                }
                resourceMap[resource].locations[location].officers[officerId] += inv.quantity;
            });
            
            const officerNames = {};
            allMembers.forEach(doc => {
                const data = doc.data();
                const prefix = data.squadron ? `[${data.squadron}] ` : '';
                officerNames[doc.id] = prefix + (data.gamertag || 'Unknown');
            });
            
            const locationNames = {};
            allLocations.forEach(loc => {
                locationNames[loc.code] = loc.name;
            });
            
            const sortedResources = Object.keys(resourceMap).sort();
            
            if (sortedResources.length === 0) {
                container.innerHTML = '<div class="resource-no-data">No guild resources tracked yet.</div>';
                return;
            }
            
            let html = '';
            
            sortedResources.forEach(resource => {
                const resourceData = resourceMap[resource];
                const resourceDisplay = resource.charAt(0).toUpperCase() + resource.slice(1);
                
                html += `
                    <div class="resource-group">
                        <div class="resource-group-header">
                            <span class="resource-group-name">${resourceDisplay}</span>
                            <span class="resource-group-total">${formatNumber(resourceData.total)} total</span>
                        </div>
                `;
                
                const sortedLocations = Object.keys(resourceData.locations).sort((a, b) => {
                    const nameA = locationNames[a] || a;
                    const nameB = locationNames[b] || b;
                    return nameA.localeCompare(nameB);
                });
                
                sortedLocations.forEach(location => {
                    const locationData = resourceData.locations[location];
                    const locationDisplay = locationNames[location] || location;
                    
                    html += `
                        <div class="resource-location">
                            <div class="resource-location-header">${locationDisplay} (${formatNumber(locationData.total)})</div>
                            <div class="resource-officer-list">
                    `;
                    
                    const sortedOfficers = Object.entries(locationData.officers)
                        .sort((a, b) => b[1] - a[1]);
                    
                    sortedOfficers.forEach(([officerId, quantity]) => {
                        const officerName = officerNames[officerId] || 'Unknown';
                        html += `
                            <div class="resource-officer-item">
                                <span class="resource-officer-name">${officerName}:</span> ${formatNumber(quantity)}
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        async function logout() {
            await auth.signOut();
            window.location.href = 'login.html';
        }

        async function loadDonationBreakdown(playerId) {
            const breakdownDiv = document.getElementById('donationBreakdown');
            
            try {
                const snapshot = await db.collection('contributions')
                    .where('playerId', '==', playerId)
                    .where('activityType', '==', 'Material Donation')
                    .get();
                
                if (snapshot.empty) {
                    breakdownDiv.innerHTML = '<div class="donation-empty">No donations yet</div>';
                    return;
                }
                
                const totals = {};
                snapshot.docs.forEach(doc => {
                    const contrib = doc.data();
                    const material = contrib.materialType;
                    const quantity = contrib.materialQuantity || 0;
                    
                    if (material && quantity > 0) {
                        if (!totals[material]) {
                            totals[material] = 0;
                        }
                        totals[material] += quantity;
                    }
                });
                
                const displayOrder = [
                    'beams', 'bulkheads', 'plates', 'canvas',
                    'iron', 'coal', 'wood', 'resin', 'fabric'
                ];
                
                const materialNames = {
                    beams: 'Beams',
                    bulkheads: 'Bulkheads',
                    plates: 'Plates',
                    canvas: 'Canvas',
                    iron: 'Iron',
                    coal: 'Coal',
                    wood: 'Wood',
                    resin: 'Resin',
                    fabric: 'Fabric'
                };
                
                breakdownDiv.innerHTML = '';
                let hasData = false;
                
                displayOrder.forEach(material => {
                    if (totals[material] && totals[material] > 0) {
                        hasData = true;
                        const item = document.createElement('div');
                        item.className = 'donation-item';
                        item.innerHTML = `
                            <span class="donation-material">${materialNames[material] || material}</span>
                            <span class="donation-amount">${formatNumber(totals[material])}</span>
                        `;
                        breakdownDiv.appendChild(item);
                    }
                });
                
                Object.keys(totals).forEach(material => {
                    if (!displayOrder.includes(material) && totals[material] > 0) {
                        hasData = true;
                        const item = document.createElement('div');
                        item.className = 'donation-item';
                        item.innerHTML = `
                            <span class="donation-material">${materialNames[material] || material}</span>
                            <span class="donation-amount">${formatNumber(totals[material])}</span>
                        `;
                        breakdownDiv.appendChild(item);
                    }
                });
                
                if (!hasData) {
                    breakdownDiv.innerHTML = '<div class="donation-empty">No donations yet</div>';
                }
                
            } catch (error) {
                console.error('Error loading donation breakdown:', error);
                breakdownDiv.innerHTML = '<div class="donation-empty">Error loading data</div>';
            }
        }

        async function loadGuildAdmirals(squadron) {
            const container = document.getElementById('guildAdmiralsList');
            
            if (!squadron) {
                container.innerHTML = '<div class="admiral-empty">No guild assigned</div>';
                return;
            }
            
            try {
                const snapshot = await db.collection('players')
                    .where('squadron', '==', squadron)
                    .where('isAdmiral', '==', true)
                    .get();
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="admiral-empty">No admirals in your guild</div>';
                    return;
                }
                
                container.innerHTML = '';
                snapshot.docs.forEach(doc => {
                    const admiral = doc.data();
                    const item = document.createElement('div');
                    item.className = 'admiral-list-item';
                    item.innerHTML = `
                        <span class="admiral-icon">‚öì</span>
                        <span class="admiral-name">${admiral.gamertag || 'Unknown'}</span>
                    `;
                    container.appendChild(item);
                });
                
            } catch (err) {
                console.error('Error loading guild admirals:', err);
                container.innerHTML = '<div class="admiral-empty">Error loading admirals</div>';
            }
        }
    </script>
</body>
</html>
